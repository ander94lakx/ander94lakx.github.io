{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2020-04-25-instagram-bot-python/","result":{"data":{"site":{"siteMetadata":{"title":"Walk on the Byte Side","disqusShortname":""}},"markdownRemark":{"id":"b81b9167-b3e1-5cdd-835e-ed81f5af3ff7","html":"<p>Instagram es la red del postureo. Es probablemente la red social que más uso. Soy demasiado joven como para usar Facebook activamente y demasiado viejo siquiera para plantearme crearme TikTok (si veis que ocurre, os doy permiso para acabar con mi existencia). También uso twitter, pero más como proveedor de “noticias”, pero no publico nada en esa red social.</p>\n<p>Por lo tanto, todas mis publicaciones suelen ir a Instagram. A lo largo de los años me he dado cuenta de que se ha convertido en una especie de diario de hitos personales. Por encima de las fotos de mis viajes se pueden ver y observar fotos de cuando me saqué la carrera, de cuando vivía en Madrid y estaba en un estudio programando un videojuego o de buenos momentos con amigos. Aunque la calidad de las imágenes puede no ser la mejor, me gusta meterme de vez en cuando ahí y ver todos esos viajes y momentos.</p>\n<p>Aun así, soy informático y se que la única manera de que tu información pueda estar segura es tener tú mismo una copia. Por ello llevaba tiempo planteándome realizar algún script que me permitiera bajarme todas las fotos de mi perfil. También podia usar esto para refrescar un poco Python y practicar algo de Web Scrapping.</p>\n<h1>Web Scrapping con Selenium</h1>\n<p>Hace tiempo hubo un intento fallido por mi parte, principalmente porque intente descargar, <em>parsear</em> y buscar las páginas a mano. El problema es que una página no consiste únicamente en un HTML, y hacerlo a mano implica ir “tirando del hilo” hasta obtener todos los recursos que componen una página. Por lo tanto lo deje aparcado. Eso hasta el otro día, en el que de pura casualidad encontré un <a href=\"https://www.youtube.com/watch?v=d2GBO_QjRlo\">video</a> en el que alguien programaba un bot para Instagram para ver la gente que le había dado unfollow. El objetivo que tenía me daba igual, pero quería ver como lo hacía.</p>\n<p>Al ver como lo hacia vi que utilizaba una librería llamada <a href=\"https://www.selenium.dev/\">Selenium</a>, que es una herramienta que permite automatizar un navegador. Es básicamente el santo grial del Web Scrapping, permite ahorrarte todo el engorro de realizar las peticiones, filtrar las páginas, buscar etiquetas, etc. Así que me baje el WebDriver para Firefox (es el puente que une la librería con el navegador), instalé la librería para Python y basándome en el video comencé a programar.</p>\n<h1>Loguearse en Instagram</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3e1843296bd3fba0d59d13eab6d68f03/b4aee/ig-login.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.37974683544303%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAACE3AAAhNwEzWJ96AAADXklEQVQ4y4WUS28TVxTH/TVoy7KtRL8BX6GVumBXFu2iol0h6oIBVQotUkXaJiBeQUQVQZAEMAZFUcmiqqI6UeySqnn4kcT22JnxaxycZOyx5z2ef8+5xq5YVFzpr3tn5s5vzvmfcyfkOA7i8ThmZ2exsLCAVDqNVCqFTCaDw0MNXcOAaZpwXRe8l2fP84R4Pbg/UGh3dxfHjn2EI0feQfRpDFq7g1yhSOAstJYO03YJasK2bfDg2aCPWJYloAzp9XoIgkDAQ4VCHtHHM1BKElS1QZA2Diiyxl5TAFnVam0IbLVaWFlZweLiolAikRg+E8BcLo9vLo8jFl/DRnYbcqWCrbyE3xZeYDO9gT/+jGMjsyU2cxQcDYsjYyt8338zwlwuh4+/jCB84zGS6ynI6h7iyVVcuXwO34a/xqkzYbzcSMP3+t51u12RsvHaW06d4Qzm56Ht7R0c/+QkPj11nqJZhlIuoyTlsfz7M8Qe3cP84hIylIXr9l8yuh24ji2uefZoZnGUrkvAbDaLE599gbHbv2IlkUR2/W/syWk41j48swlDb0OpqXBsC4YToNiwIb9yUTnwUNn3IDdduvZgOj2RRWhnZwcXzpzG5K1bWF9bQ/RJFM+jTzBxcxx/xV/AJahSrcPmqvaAjhXAdIG24dHaR9cOoJs9eH5AKRMwXyjgx+8uYnLsqui9ufl5XBv7Gae/+hxzsUcEcQlYE17xYL80TYdlWuh02EuT7gb/VZk9m3v2HOuJJerBNl6uriJG/VjMFyAVFQIGqNXrQ6Dn+egYFtp6V8hxPFHhYZVLuzLmolEUqDj1Wg1lpYy8pGCvqUGRZTLbR43uc0XZ+H6b+MNTwtcD9Ru7WMIPl77H5N071B7baFTz0OtraDWytMkTUamqKoAcBTcxtw5HzNJ0BzZF2a8yASUC3r4+jn9WE9jKFVGWc1DLaTRVSUAMowtFUcT6bUOcZUkq4N33juL9Dz7E8tISHbsWlEodxZIijlxFqCq+zkWbmpoSmpmZwf2HD3B/6h4mJu5gc3NTQEMc9vT0NEZHRyFJRUrHQHP/AFXy7VDTxNlukTilZDKJkZERRCIR2v8Troz9gsi5swiHw+KPJYD85cHgdZsqzdIIxj8CXdeFV4MC/N9gfznlfwFdnXwGhsUSnwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Web de login de instagram\"\n        title=\"Web de login de instagram\"\n        src=\"/static/3e1843296bd3fba0d59d13eab6d68f03/f058b/ig-login.png\"\n        srcset=\"/static/3e1843296bd3fba0d59d13eab6d68f03/c26ae/ig-login.png 158w,\n/static/3e1843296bd3fba0d59d13eab6d68f03/6bdcf/ig-login.png 315w,\n/static/3e1843296bd3fba0d59d13eab6d68f03/f058b/ig-login.png 630w,\n/static/3e1843296bd3fba0d59d13eab6d68f03/40601/ig-login.png 945w,\n/static/3e1843296bd3fba0d59d13eab6d68f03/78612/ig-login.png 1260w,\n/static/3e1843296bd3fba0d59d13eab6d68f03/b4aee/ig-login.png 1823w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Lo primero que hay que hacer es hacer <em>log in</em> en la página. Para ello, lo que hay que hacer es lo siguiente</p>\n<ol>\n<li>Obtener la web. Al no habernos logueado, la web que aparecerá será la de login</li>\n<li>Obtener los campos de usuario y contraseña y llenarlos</li>\n<li>Pulsar el botón de <em>Log in</em></li>\n</ol>\n<p>Todo ello se hace en Python de la siguiente manera:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">InstaBot</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> pw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>driver <span class=\"token operator\">=</span> webdriver<span class=\"token punctuation\">.</span>Firefox<span class=\"token punctuation\">(</span>executable_path<span class=\"token operator\">=</span><span class=\"token string\">\"./geckodriver.exe\"</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>username <span class=\"token operator\">=</span> username\n        self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"https://instagram.com\"</span><span class=\"token punctuation\">)</span>\n        sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>    \n        self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">\"//input[@name=\\\"username\\\"]\"</span><span class=\"token punctuation\">)</span>\\\n            <span class=\"token punctuation\">.</span>send_keys<span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">\"//input[@name=\\\"password\\\"]\"</span><span class=\"token punctuation\">)</span>\\\n            <span class=\"token punctuation\">.</span>send_keys<span class=\"token punctuation\">(</span>pw<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'//button[@type=\"submit\"]'</span><span class=\"token punctuation\">)</span>\\\n            <span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        sleep<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">\"//button[contains(text(), 'Ahora no')]\"</span><span class=\"token punctuation\">)</span>\\\n            <span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Como se puede ver, he metido el código en el constructor de una clase, que es la clase donde voy a implementar todo. Está en el constructor porque, independientemente de lo que se quiera hacer, es necesario realizar ese login. Los <code class=\"language-text\">sleep()</code> son necesarios ya que hay que dejar tiempo para que cargue la página.</p>\n<p>Si se ejecuta eso, se ve que en realidad es el mismo proceso que realizaría cualquiera para meterse en Instagram, solo que automatizado. Incluso se puede ver en directo en el navegador aislado que abre el WebDriver. No voy a indagar en cada función, ya que creo que los nombres son muy explicativos y es fácil comprender que esta haciendo cada una.</p>\n<h1>Obtener todos los posts</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/e8212/ig-posts.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.64556962025317%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAACE3AAAhNwEzWJ96AAAEfElEQVQ4yx2UazTVWRjG/x9mPrRmlpku0zSXLqaRmRRlEqU0qpEYKemEKFTEEYkZ06xJU7qNy3E0TrkkU5NLRSkpEiJdkMuhRe51WplEdMU5B7/5H3utZ+213v0+z/Ou9917C6/6+2lpbuZlby+6NTIywvCwDsNj0Gg0DA4OMjQ0hEatHouNjo6O5b1//563Iu/dmzf09fXR09ODoCOMjIyOJQ4NiUSRrBPoF43Uag0DA0OoNcMMDmnQaIfRimZv374ZM9JqdTGtmKceM9RB6OnpJftiFrV1St4NahlUj9D55Bkdne20NRbzqC6P9rrLnI7ZSeg2W+KOhvFE1YWy/hFtbZ28fvUatSikK0grigs1NVUcjggjJSkOeXQUEQcikCuSyLt2CVVFJC1FQbxsiiUn2h5v608I3rKSu3fvU1R8h8rKGkpLSqhvaKYgv4jmpiaEspJ8fg/dzqF9IURIN7Nu6Q94uLtQXJhLS95OGi+sobsqkI4b3viv/oIAdxvOZWYgizpMUoKCsNBgZDExbPXcIooXI1zPy8FNYs/unduQblyDv8QBL08f0s+kkibz4i+pGcm7FpK+dymrTMfhKVlGwvF4nJ3WsslFwvp1jjistsNqiSWFNwoRim+V8kf4nySlpLDB2ZnFZmYYmViSciqZYG9rls7TY/2yr1hpOhGDLwW83VYQK5Mxx8QQB0drbGwtWGVriYHhDG4W3kRoammhqKycsxnnWLBQdzCbqdNnEq+Iw8FuLgvmfIzt4imYz53AvFnj2CSxQR5/EDvJbFx9zUVY4OZngYOrCbfK8hGUylqyz2dwKSsTRVwMifFyjskiqaq4Jza7nqqqCupqq8W9ktvld8RYI7fvlKBIkJF0UkFicvwYTiTG0twqDiVeHs0UvQ/47uvxmOh/hsk3k5k2/kNOJZ6gu2+Y6noVBaX1tKv6edj8nGfPB9i7dz+TJk5iloEB06fNQF9fHz298WRlZSPUVpazy8eFeYbTsDCaisOSWRjPmMCp5ES6XgxwKbeUg5GJdKh6qKxppe1xL/HyKJaYfot06wZ2bHHCx9WeFZbzycu7KvZQeY/9u91x/NEIDzsjXGwM8XQ0p6w4n46nfeQWVHBEfoZqZSu1DZ08au8mIzmWIFcrgjbZ4u/yE4HudgRvXs2DeyXiPbx5lbUrzXGymonnz8b4uVlxKFSCsrIUZdNTDstSCQk/hjTkCOnZRTS19XDh5FHC3Objs24RPusXEei2HA97M4oLchGqy/P51cuaPV4W+DrNYbfLbPyc53Plwmk2e0qxlezCJyQSD799bPTeg/zvVCJ+k2I8WWC58RSMpn6E6cxP+f5zges5mQitTXX8mxRF9JFwQoICCAn0J8B3O1dyLnI8IRnFyfP8k3mNtKx8kk9nk5aZzZWsNI7tlxJ7IJjgAF9+CdyBIvYgHW3ilJ/918vDRhXtHd08VvWKD7+X1vYuup73oWzt5n7DEypE3K9/TOmDVhraXpCWkY5CEcPli2fJz80kNfUE0eFB4idyl/8BShx3H52Lb/QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Posts de Instagram\"\n        title=\"Posts de Instagram\"\n        src=\"/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/f058b/ig-posts.png\"\n        srcset=\"/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/c26ae/ig-posts.png 158w,\n/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/6bdcf/ig-posts.png 315w,\n/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/f058b/ig-posts.png 630w,\n/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/40601/ig-posts.png 945w,\n/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/78612/ig-posts.png 1260w,\n/static/cb99ba5e05a3d32f6de2a5f5de23d0e8/e8212/ig-posts.png 2239w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Una vez hecho eso, mi idea era ir a la página del perfil, coger cada enlace a cada post y de cada uno coger la URL donde se encuentra la imagen. Este es un proceso que ya he hecho a mano, por lo tanto se que las imágenes de Instagram se pueden coger si vas inspeccionando el HTML en búsqueda de la URL de la imagen, la URL de un post suele ser algo así, que esta en la etiqueta <code class=\"language-text\">&lt;img></code> anidada por varios <code class=\"language-text\">&lt;div></code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6f23817dc4c6d4ac55900e302034e8b9/7ca1f/ig-image-post-url.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAACE3AAAhNwEzWJ96AAABfklEQVQoz32S627TQBCF8/6PgECItEj0HzwEpJVSpAZQRCkpJQ252I73Zu96nfhj7OCoXMpIR7Nr+Zy5nB2kuiD7kbNNDdZGClMJIkZVJHmJtp4i7DBlJBSRSrJ1BSEEmqahjT63MfCxJs0C2aYgWWt0aqlcRRSir0RA0JMO6G5HgYdinSDNnrV0pVYli6VimQdMZijKQIzVP4ntsS/we7FGBCWqGElS6XJZ8n2+ZbHRGBdR0mlmZOSi+Iv4GAa/apIJ2a08m7VlvnQs1orSBpytMNZQP+j2fzE4vSw5vfQMx46XbxWvBC8EZyPDG/n2WnA21gwvNM8vCobnjmcjy5N3lqcjx8m45EQ02txqDULd0CLuGlaJZzLdMpkprq9zJl8VV18U7z/nfLzNmd5pZnPLp2+aq5nmw61mOnfcy5qSm3t5JaEf+TB2knvyrSdVAtldmjtsWXdPxvvArt51/h7M6Jxhvz/k48i9U76qO3L73/7oYPPorpo/zr0pPwHr8LKpplI35QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"URL de la imagen de un post de Instagram\"\n        title=\"URL de la imagen de un post de Instagram\"\n        src=\"/static/6f23817dc4c6d4ac55900e302034e8b9/f058b/ig-image-post-url.png\"\n        srcset=\"/static/6f23817dc4c6d4ac55900e302034e8b9/c26ae/ig-image-post-url.png 158w,\n/static/6f23817dc4c6d4ac55900e302034e8b9/6bdcf/ig-image-post-url.png 315w,\n/static/6f23817dc4c6d4ac55900e302034e8b9/f058b/ig-image-post-url.png 630w,\n/static/6f23817dc4c6d4ac55900e302034e8b9/40601/ig-image-post-url.png 945w,\n/static/6f23817dc4c6d4ac55900e302034e8b9/78612/ig-image-post-url.png 1260w,\n/static/6f23817dc4c6d4ac55900e302034e8b9/7ca1f/ig-image-post-url.png 1890w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Pero antes de llegar a eso, es necesario coger los enlaces a todos los post, para poder buscar el enlace de la imagen para cada uno de ellos. Los enlaces de un post de Instagram tienen el formato <code class=\"language-text\">https://www.instagram.com/p/B--N-oBKdPL/</code>. Para cogerlos, una vez llegados la página del perfil, hay que ir bajando abajo e ir buscando estos enlaces. </p>\n<p>Mi idea inicial era hacer scroll hasta abajo del todo y después buscar todos los enlaces. El problema es que la página de perfil solo mantiene un número de post cargados en el grid y, a medida que se va bajando y se va cargando nuevos, los anteriores desaparecen. En mi experiencia suele mantener cargados en torno a 30. Por lo tanto, lo que habría que hacer es hacer scroll e ir cogiendo los enlaces. Para ello he creado la función <code class=\"language-text\">get_pictures_links()</code>, que contiene lo siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_pictures_links</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">\"//a[contains(@href,'/{}')]\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\\\n        <span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n    links <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    last_height <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>execute_script<span class=\"token punctuation\">(</span><span class=\"token string\">\"return document.body.scrollHeight\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>execute_script<span class=\"token punctuation\">(</span><span class=\"token string\">\"window.scrollTo(0, document.body.scrollHeight);\"</span><span class=\"token punctuation\">)</span>\n        sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n        links_elements <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_elements_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'//a[contains(@href,\"p/\")]'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">for</span> elem <span class=\"token keyword\">in</span> links_elements<span class=\"token punctuation\">:</span>\n            links<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">.</span>get_attribute<span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        new_height <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>execute_script<span class=\"token punctuation\">(</span><span class=\"token string\">\"return document.body.scrollHeight\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> new_height <span class=\"token operator\">==</span> last_height<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">break</span>\n        last_height <span class=\"token operator\">=</span> new_height\n\n    links <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>links<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> links</code></pre></div>\n<p>Hay varias cosas a resaltar en el fragmento anterior:</p>\n<ul>\n<li>El scroll se hace mediante JavaScript. Para ejecutar código JavaScript en la web se usa la función <code class=\"language-text\">execute_script()</code></li>\n<li>El contador de altura sirve para saber cuando hay que parar de bajar. Si al bajar sigue en la misma altura del final se para</li>\n<li>\n<p>Para buscar los enlaces a los post hay que buscar las etiquetas <code class=\"language-text\">&lt;a></code> correspondientes. En este caso se busca una etiqueta de enlace que contenga <code class=\"language-text\">/p</code> en el atributo <code class=\"language-text\">href</code>.</p>\n<ul>\n<li>Una vez obtenida la etiqueta o, como en este caso, la lista de etiquetas que cumplen ese criterio, se obtienen los atributos en sí, que son las URL que queremos. Estas se guardan en la lista.</li>\n</ul>\n</li>\n<li>Por como funciona el grid, lo normal es acabar cogiendo valores repetidos, ya que las etiquetas se van descargando al cabo del tiempo, pero se mantienen durante varios scrolls. Por lo tanto, al final del todo, se hace el <code class=\"language-text\">list(set(links))</code> para eliminar duplicados (se pasa a un set, que no puede contener repetidos, y después a una lista para dejarlo como antes). Hacer eso deja los elementos desordenados, pero en este caso no importa. De las soluciones que he encontrado en <a href=\"https://stackoverflow.com/a/7961393\">StackOverflow</a>, esa me parecía la más limpia y apta para este caso.</li>\n</ul>\n<h1>Obtener los <em>permalinks</em> a las imágenes</h1>\n<p>Con todos los posts, no queda más que ir uno a uno, para abrirlos y buscar las imágenes que contienen. Para ello, he creado la función <code class=\"language-text\">get_picture()</code>, a la que le voy pasando cada uno de los links que previamente he obtenido y busco la imagen para descargarla.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_picture</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> link<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">)</span>\n    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        img_element <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'//img[contains(@class,\"FFVAD\")]'</span><span class=\"token punctuation\">)</span>\n        url <span class=\"token operator\">=</span> img_element<span class=\"token punctuation\">.</span>get_attribute<span class=\"token punctuation\">(</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">)</span>\n        time_element <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span>find_elements_by_tag_name<span class=\"token punctuation\">(</span><span class=\"token string\">'time'</span><span class=\"token punctuation\">)</span>\n        timestamp <span class=\"token operator\">=</span> time_element<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>get_attribute<span class=\"token punctuation\">(</span><span class=\"token string\">'datetime'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> url <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">and</span> timestamp <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            timestamp <span class=\"token operator\">=</span> timestamp<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span>\n            timestamp <span class=\"token operator\">=</span> timestamp<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n            urllib<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>urlretrieve<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> timestamp <span class=\"token operator\">+</span> <span class=\"token string\">'.jpg'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span></code></pre></div>\n<p>Obviando que no trato la excepción (y debería), aquí es donde realmente ocurre la magia y donde hay más problemas. De momento la forma más sencilla que he encontrado para obtener la etiqueta que contiene la imagen real, es buscarla mediante su clase. Los nombres de todas las clases que se usan en el HTML de la web de Instagram están ofuscados. Pero, basándome en las pruebas que he estado realizando, estos no cambian en el tiempo, por lo tanto usando ese nombre de clase. Una vez sabiendo cómo hacerlo, es muy fácil encontrar con Seleniun la etiqueta y obtener la URL.</p>\n<p>Además, para poder guardar las imágenes también obtengo el timestamp de cuando se publicó el post. A partir de ahi, no hace falta mas que descargar la imagen con <code class=\"language-text\">urllib</code>.</p>\n<h1>Conclusión</h1>\n<p>El bot tiene muchas partes con margen de mejora. Hasta ahora no he hablado de los post que contienen un video ni de los post que contienen varias imágenes. Iré mejorándolo con el tiempo, pero creo que tal y como esta es una buena herramienta para entender como hacer Web Scrapping a nivel básico. Voy a dejar el código en un <a href=\"https://github.com/ander94lakx/InstaBot\">repositorio de GitHub</a>, donde se irán pudiendo ver dichas mejoras.</p>\n<h1>¿Y la API de Instagram?</h1>\n<p>En este punto quizás alguien se plantee por que hacer todo esto y no usar directamente la API de Instagram. Por un lado, se que hay una nueva API, pero no la conozco. Mi objetivo es intentar hacer lo mismo que hace esta herramienta pero con dicha API. La que conozco es API anterior, la cual me parece limitada y pronto quedará en desuso.</p>\n<p>Aun así, el objetivo de este bot es no depender de si Instagram te va a permitir obtener dichas imágenes o no. Al fin y al cabo, una vez habiéndote logueado en la aplicación, técnicamente se pueden coger todas las imágenes que quieras, por lo que deberías ser capaz de hacerlo también de manera programática.</p>\n<p>Al final, no consiste en si Instagram te va a dejar o no, sino en: ¿si puedes, por qué no hacerlo?</p>","frontmatter":{"title":"Cómo descargarse las imágenes de un perfil de Instagram con Python y web scrapping","date":"April 25, 2020","description":null,"template":"post"}}},"pageContext":{"slug":"/blog/2020-04-25-instagram-bot-python/","previous":{"node":{"fields":{"slug":"/blog/2020-04-11-covid-remote-work/"},"frontmatter":{"date":"11 April, 2020","title":"No tenemos ni idea de cómo hacer teletrabajo y cómo podemos solucionarlo","template":"post"}}},"next":{"node":{"fields":{"slug":"/pages/about/"},"frontmatter":{"date":null,"title":"Sobre mí","template":"page"}}}}},"staticQueryHashes":["2841359383","3810545343","916993862"]}