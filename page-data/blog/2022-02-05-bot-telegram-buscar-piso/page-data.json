{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2022-02-05-bot-telegram-buscar-piso/","result":{"data":{"site":{"siteMetadata":{"title":"Walk on the Byte Side","disqusShortname":""}},"markdownRemark":{"id":"43f35085-89cf-532b-92d5-e489ff38c352","html":"<p>Estoy buscando piso y es un proceso de mierda. Hay una cantidad extrañamente escasa de pisos en mi ciudad y los que hay desaparecen rápidamente.</p>\n<p>Me da pereza meterme todo el rato a buscar piso. En realidad no es algo tan complicado, pero a veces estoy ocupado y se me pasa mirar ese día, o estoy fuera y con el móvil es más engorroso.</p>\n<p>Llevaba tiempo queriendo probar a hacer un bot de Telegram. No sabía que hacer exactamente, pero el otro día se me iluminó la bombilla. As que he creado un bot que me avisa de los pisos que hay en mi ciudad disponibles.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff41f125f3a3f618b3ef73d752e60669/0f98f/scraping_telegram_python_bot.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.49367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB0JJNxYLlf//EABoQAAICAwAAAAAAAAAAAAAAAAECERIAAyL/2gAIAQEAAQUCmgd4FQc2Nwy3UsZ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAgIDAAAAAAAAAAAAAAAAAREAEAIxcf/aAAgBAQAGPwLUCxdCBkjlf//EABoQAQEBAQADAAAAAAAAAAAAAAERACExQaH/2gAIAQEAAT8h8tD8zs7i57pkag90+AHtiRbv/9oADAMBAAIAAwAAABD4z//EABcRAQADAAAAAAAAAAAAAAAAAAEQETH/2gAIAQMBAT8QpXY//8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EDCf/8QAHBABAAIDAQEBAAAAAAAAAAAAAQARITFBcZGx/9oACAEBAAE/EAjeWijCEwzY3fhRGA1s7j9hIRbfkEpligdb+ThB1n//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scraping Python Telegram bot\"\n        title=\"Scraping Telegram bot hecho en Python\"\n        src=\"/static/ff41f125f3a3f618b3ef73d752e60669/828fb/scraping_telegram_python_bot.jpg\"\n        srcset=\"/static/ff41f125f3a3f618b3ef73d752e60669/ff44c/scraping_telegram_python_bot.jpg 158w,\n/static/ff41f125f3a3f618b3ef73d752e60669/a6688/scraping_telegram_python_bot.jpg 315w,\n/static/ff41f125f3a3f618b3ef73d752e60669/828fb/scraping_telegram_python_bot.jpg 630w,\n/static/ff41f125f3a3f618b3ef73d752e60669/0ede0/scraping_telegram_python_bot.jpg 945w,\n/static/ff41f125f3a3f618b3ef73d752e60669/3ac88/scraping_telegram_python_bot.jpg 1260w,\n/static/ff41f125f3a3f618b3ef73d752e60669/0f98f/scraping_telegram_python_bot.jpg 1920w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Esto tiene dos partes. Una es la parte de web scraping. Esto es básicamente automatizar la extracción de información de sitios web. Hoy en dia casi todo se hace desde internet y buscar piso no iba a ser menos. Prácticamente todas las inmobiliarias locales y los particulares que alquilan piso cuelgan sus anuncios en alguna plataforma como Idealista o Fotocasa, así que consultando ahí puedo ir viendo que opciones nuevas van apareciendo. Es básicamente lo que estaba haciendo hasta ahora a mano y sin la constancia suficiente. Automatizándolo con web scraping me permite obtener toda esa información de un vistazo.</p>\n<p>La otra parte es la del bot de Telegram. Hasta hace dos días no tenia ni idea de como iba. Básicamente Telegram tiene una API cojonuda para poder hacer de todo con ella. Se pueden crear bots que se ejecuten donde sea para comunicarse directamente con los usuarios, escribir en chats o canales y realizar mil cosas. A parte, hay un <a href=\"https://github.com/python-telegram-bot/python-telegram-bot\">wrapper para Python</a> muy bueno con el que se puede utilizar la API desde Python de manera muy sencilla.</p>\n<h2>Parte 1: web scraping con Selenium</h2>\n<p>No es la primera vez que hago web scraping. Hace tiempo hice un script que permitía scrapear instagram para descargar todas las imágenes de un usuario. Podéis echar un vistazo al <a href=\"https://ander94lakx.github.io/blog/2020-04-25-instagram-bot-python/\">post</a> que hice o al <a href=\"https://github.com/ander94lakx/InstaBot\">código</a> del bot (es un bot, pero no es un bot de Telegram, ojo).</p>\n<p>Cuando hice ese script utilicé <a href=\"https://www.selenium.dev/\">Selenium</a>, que es probablemente la mejor herramienta para web scraping que existe. No sirve solo para eso, pero permite automatizar el manejo de navegadores. Con esto lo que se puede hacer, es abrir webs, navegar por ellas, realizar acciones y extraer información de ellas programáticamente. Esto es mucho mejor que mandar directamente request con una librería para realizar peticiones, ya que al lanzar realmente una instancia de un navegador, se pueden saltar medidas que algunos sitios web tienen para bloquear mecanismos automatizados. La pega que tiene es que, al tener que abrir un navegador, no se puede ejecutar en un entorno que no tenga pantalla (aunque esto se puede solucionar fácil con librerías que simulan pantallas como <a href=\"https://pypi.org/project/PyVirtualDisplay/\">PyVirtualDisplay</a>).</p>\n<p>Con las herramientas listas e instaladas, solo queda usar Selenium para comenzar a hacer web scraping. En este caso lo simple es mejor. en vez de pasarle la URL base de un sitio de búsqueda de pisos, se puede sacar las URL con los parámetros para filtrar la búsqueda. En mi caso, y poniendo Idealista como ejemplo, la URL sería algo así:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">https://www.idealista.com/alquiler-viviendas/vitoria-gasteiz-alava/?ordenado-por<span class=\"token operator\">=</span>precios-asc</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Como se puede ver, ya estoy filtrando por mi ciudad, a parte de que ordena por precio para que aparezcan los más baratos primero (no hay mucha pasta por aquí). Esto se podría acotar mucho más. Como la mayoría de sitios de este tipo usan los parámetros de búsqueda en la propia URL (algo muy útil para poder después guardar marcadores con ello), se puede ahorrar muchísimo trabajo de scraping solo con elegir la URL adecuada.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0e83e25c534428cbc1a9ce2e02db10bf/e8d8a/idealista_web.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.74683544303798%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAB2HAAAdhwGP5fFlAAADwklEQVQ4y0WU228bVRDG/bfwgPoXUCHxlGfEAzwgEG88I1EpQANVAadpqrYhQaUp6U1AgbRqBaIvLWoLqiDKtWma1Inj2Fnbu16v7fVe7L3Z6/jH7KbASqOZs+fsd76Z+WYza3snWMyNoTgT1IJJNG8CVUyXWA/O/O/D0+jOt5TNq+y3LqNKXDEn2W1kxZ9ir56V706T8aOIsNfD9UOCqEfXc+h0bAYHPSBmOIw5GPYZJrEYDF5Ysu6LP3hhg3Q/025b6HqdRrOJ0WhIbFBWKtRqOqqmpXuaqqFpNSqVKmr1MB4KxnAIkZAIw4h+Xy4+GJJRW7fYKk2Qr0yTU06jNu8IQw/PcfAatjDu4nmevHNT6/f79OOEmaDJs7HxlJu35ikUduRsh0xu/iILo5+ylM2y8NEYu3evEAr1bifCMztyyP3PPL+D61q0WgZ6vcrKyiIPH95HUfaoVPdpWy0y28oyyzuPKChrbOQXyaur2IZsqo9pGTncTgJii3fEO1hOB9OyaZgmO7sFnj3PydrCtk05Ywtgc4vF6iJFZZOV4lNy7QK52x+z+ts7VDbmGEj9e9K0KGmeWC8e0kveDf5NWtpxcOj7/R6Z3Xqe5c2/eLLyJ5trC9IAFXX9F5Snd7FqTyR1qWfXJZbDgziml4D2xMKQKPAJfT9dJ2BB6JMx2iWeF9d5srPMUn4B1S2ztrrO5Us3mP/+V/54sMz1b74mv7GGqmhYqk5Xb+LZHXyni293iXsiK2l5FIVkbLOMJbWpmzZKS+W58Yy/f7/PxKlpTp48z52fbzOTPUGtsoftuthtqZVt4YgKooSZdDxOu07KNFOuFNne2aJYLGAYOo1GjZ8unOWtkVcZHzvO+2+OMPLKETRlN9Wa5/l0/SitaZJ+mKQuWowHw/SCTE1XpeUKttPGSSRhNrk3P8eV8Q/57sI5Pj9+jM8+OUalXBKGXQyRkt4OcD0BlVQ7Am66AYbli6w8MlqtKrpqyKTUMdtNmZAKm+tL/HBtlq/OjvPj9VluXJ0lXyhR0dsYbZ9OEGN1ezheX4DF/Bg/GogKwoRhVUQqI1ZXaYpgNa3M40f3mTqT5fzkF1y5OMXszDn2S6V0UmyrjetYqTYDqX0ceCItmXGZxbSGtZqaMkwsUXrd0Lh2aYY3jh7h7aMv8d5rL/PBu6/LfCupDh23I6kn6QVpHYMgxA+SH8zgsIZKWZqyvcluYVvAVOrC9MG9u0yPjzHz5SiXsqPcnJtCl9Ikk2I7Li1HQOSHMBj05RJJvRtgOr4A+/wDjRB3VTzbQyoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Resultados de Idealista\"\n        title=\"Resultados de la búsqueda en Idealista\"\n        src=\"/static/0e83e25c534428cbc1a9ce2e02db10bf/f058b/idealista_web.png\"\n        srcset=\"/static/0e83e25c534428cbc1a9ce2e02db10bf/c26ae/idealista_web.png 158w,\n/static/0e83e25c534428cbc1a9ce2e02db10bf/6bdcf/idealista_web.png 315w,\n/static/0e83e25c534428cbc1a9ce2e02db10bf/f058b/idealista_web.png 630w,\n/static/0e83e25c534428cbc1a9ce2e02db10bf/40601/idealista_web.png 945w,\n/static/0e83e25c534428cbc1a9ce2e02db10bf/78612/idealista_web.png 1260w,\n/static/0e83e25c534428cbc1a9ce2e02db10bf/e8d8a/idealista_web.png 2349w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Con eso en mente, he creado una sencilla función que permite hacer web scraping para obtener los pisos. Le he puesto una opción para filtrar por precio (aunque es algo que se puede hacer también a través de la URL). El código es el siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">scrap_idealista</span><span class=\"token punctuation\">(</span>max_price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    driver <span class=\"token operator\">=</span> initialize_driver<span class=\"token punctuation\">(</span>IDEALISTA_URL<span class=\"token punctuation\">)</span>\n    scroll_down_and_up<span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Be kind and accept the cookies</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        driver<span class=\"token punctuation\">.</span>find_element_by_id<span class=\"token punctuation\">(</span><span class=\"token string\">'didomi-notice-agree-button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span> <span class=\"token comment\"># No cookies button, no problem!</span>\n\n    <span class=\"token comment\"># Find each flat element</span>\n    elements <span class=\"token operator\">=</span> driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'//*[@id=\"main-content\"]'</span><span class=\"token punctuation\">)</span>\n    items <span class=\"token operator\">=</span> elements<span class=\"token punctuation\">.</span>find_elements_by_class_name<span class=\"token punctuation\">(</span><span class=\"token string\">'item-multimedia-container'</span><span class=\"token punctuation\">)</span>\n\n    flat_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Get the link for that flat</span>\n        link <span class=\"token operator\">=</span> item<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'./div/a[@href]'</span><span class=\"token punctuation\">)</span>\n        link <span class=\"token operator\">=</span> link<span class=\"token punctuation\">.</span>get_attribute<span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Get the price for that flat</span>\n        result <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">(</span><span class=\"token string\">'.*\\\\n(.*)€\\/mes'</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n        price_str <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n        price <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>price_str<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> price <span class=\"token operator\">&lt;=</span> max_price<span class=\"token punctuation\">:</span>\n            flat_list<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> \n                <span class=\"token string\">'link'</span><span class=\"token punctuation\">:</span> link<span class=\"token punctuation\">,</span> \n                <span class=\"token string\">'price'</span><span class=\"token punctuation\">:</span> price<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'image'</span><span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>screenshot_as_png<span class=\"token punctuation\">,</span> \n                <span class=\"token string\">'image_name'</span><span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token operator\">+</span> <span class=\"token string\">'.png'</span> \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    \n    driver<span class=\"token punctuation\">.</span>quit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> flat_list</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Aquí se ven varias cosas, pero por lo general es bastante sencillo de entender. Antes que nada, se carga el driver de Selenium y se hace scroll por toda la página. Lo primero carga la web y permite tener todo listo para comenzar a buscar. El scroll es debido a que, en ocasiones, las webs van ofreciendo contenido a medida que el usuario va haciendo scroll, por lo que hacer un scroll rápido antes de comenzar a sacar información está muy bien.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">initialize_driver</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    driver <span class=\"token operator\">=</span> webdriver<span class=\"token punctuation\">.</span>Chrome<span class=\"token punctuation\">(</span>executable_path<span class=\"token operator\">=</span><span class=\"token string\">'./chromedriver.exe'</span><span class=\"token punctuation\">)</span>\n    driver<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    driver<span class=\"token punctuation\">.</span>set_window_position<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    driver<span class=\"token punctuation\">.</span>set_window_size<span class=\"token punctuation\">(</span><span class=\"token number\">1920</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1080</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> driver</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Usar Selenium es muy sencillo. En este caso estoy usando el driver para Chrome, que tengo justo en mi directorio, por conveniencia. Tras ello, cargar la URL y configurar la ventana para que tenga un tamaño decente. Esto es importante, porque los elementos estarán colocados de diferente manera en función del tamaño de la ventana. El diseño responsive está muy bien, pero es uno de los peores enemigos del <em>scrapper</em>, así que poner una resolución consistente es importante para obtener siempre los mismos resultados.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">scroll_down_and_up</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    driver<span class=\"token punctuation\">.</span>execute_script<span class=\"token punctuation\">(</span><span class=\"token string\">'window.scrollTo(0, document.body.scrollHeight);'</span><span class=\"token punctuation\">)</span>\n    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    driver<span class=\"token punctuation\">.</span>execute_script<span class=\"token punctuation\">(</span><span class=\"token string\">'window.scrollTo(0, 0);'</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>En lo que respecta al scroll aquí no hay nada especial. Un poco de JS y listo.</p>\n<p>La chicha está después. Lo primero, aceptar las cookies para poder navegar por el sitio y que no se vea nada raro. Aquí es donde se puede ver la potencia de Selenium</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">driver<span class=\"token punctuation\">.</span>find_element_by_id<span class=\"token punctuation\">(</span><span class=\"token string\">'didomi-notice-agree-button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Se explica solo. Se coge el elemento con ese ID, que en este caso es un botón, y se click. Lo siguiente es buscar los elementos con la información de los pisos. Esas tarjetitas que aparecen en lista. Como todos los elementos de una web, tienen clases o atributos que los identifican.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">elements <span class=\"token operator\">=</span> driver<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'//*[@id=\"main-content\"]'</span><span class=\"token punctuation\">)</span>\nitems <span class=\"token operator\">=</span> elements<span class=\"token punctuation\">.</span>find_elements_by_class_name<span class=\"token punctuation\">(</span><span class=\"token string\">'item-multimedia-container'</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>En este caso he hecho búsquedas con XPath y a través de los nombres de las clases. Si se ve la web de idealista, se puede sacar esta información. En cada web será diferente. Lo bueno de Selenium es que te permite obtener elementos y después buscar dentro de ellos. Así, se puede ir paso a paso hasta llegar a donde se quiere.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16be55df67c84a2cfa6f9c3db1334fbd/7e23a/idealista_scraping.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.36708860759494%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACiElEQVQoz22SWU8TURiG+0dYS2npRmnLWhaFgoSYsMiNf8Ff4K3RK2NEE41xiWEJQQgRpJRaymLDIgQFNayFtiyaUmynDEXxQvp4OhivnOTJd85k8uR9zxmVlEggSRKxeJxIJELk8JBoNPqP9LtYLMbv83NSqRTpp6W1nYJ8G9XF9RSZS1HnFaBWawU6VLIs8/3oiB+nSUidi89Tf2d6eSH4FZEJPplRiM+GaW6/hjpHR4mtBpulnCJTCSaDDYOhEFVcPkE6SSPjf7/AiG8C96SfkfEp3L4pXF4fff2DLEzPsfVlg8jBIW3t1ykwFlNlrcJqrqCw0IHFUonZXI5qcGaFoc/zuLYO6FvZo3tpWxCk60OYHkH3UkjZD29Hce9LTG/KNNa3ojeWUFPWiMNWR7VIajWXYdDbUPV4/fQvz+EKfGX825ng5384w7OXFMITJteT1NU0ifMy4LA3UFp0GUeJE7tIqdeJyp3vAjyfWaN7McSL2XUGPoUZDcQY3YnjDkpiSri244yFj3HvyYrQeamJXI1JJGvAUdSA3e6kvKwBq6UC1TPvKreHZrnv+UiHe47epS2GNqOMCKFLMBpMCJnM2K6sJJwSwkZnMxqtiTJRtdhSJc5PVLbWYDKKyvd6fdx8OcCdV2Pc6HhK58I6nv3khTCdMJTAnU4ncO0eKwmvXmkTv4oGXYERrVZPvtZIfm4+Wo0W1WOR7qF7irvD09zqf0vvsqi8e8rQToI3QSFKJwvLinBYyH2rMvXOFrKFICszB73BiNpcSY65VpmqLn+ADu8cDzzzPPItCuEugxtHvA7Exc1KCi4hd4VkhoV4Yk2mtq6F3CwdeRl5ZOcItBYyNWYy1Hr+AK+OL/wvlxPPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Scraping en Idealista\"\n        title=\"Elementos a buscar con Selenium\"\n        src=\"/static/16be55df67c84a2cfa6f9c3db1334fbd/f058b/idealista_scraping.png\"\n        srcset=\"/static/16be55df67c84a2cfa6f9c3db1334fbd/c26ae/idealista_scraping.png 158w,\n/static/16be55df67c84a2cfa6f9c3db1334fbd/6bdcf/idealista_scraping.png 315w,\n/static/16be55df67c84a2cfa6f9c3db1334fbd/f058b/idealista_scraping.png 630w,\n/static/16be55df67c84a2cfa6f9c3db1334fbd/40601/idealista_scraping.png 945w,\n/static/16be55df67c84a2cfa6f9c3db1334fbd/78612/idealista_scraping.png 1260w,\n/static/16be55df67c84a2cfa6f9c3db1334fbd/7e23a/idealista_scraping.png 2850w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Buscar a través del id y de las clases es sencillo. Buscar a través de XPath es más complicado pero muy potente. Esto se puede simplificar con una extensión como <a href=\"https://github.com/trembacz/xpath-finder\">xPath Finder</a>, que te permite obtener el XPath de cualquier elemento de una web.</p>\n<p>Con ello ya se tienen una lista de items, que son cada una de las tarjetitas esas. Aquí solo queda sacar la información que se quiera sacar.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Get the link for that flat</span>\n    link <span class=\"token operator\">=</span> item<span class=\"token punctuation\">.</span>find_element_by_xpath<span class=\"token punctuation\">(</span><span class=\"token string\">'./div/a[@href]'</span><span class=\"token punctuation\">)</span>\n    link <span class=\"token operator\">=</span> link<span class=\"token punctuation\">.</span>get_attribute<span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Get the price for that flat</span>\n    result <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">(</span><span class=\"token string\">'.*\\\\n(.*)€\\/mes'</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n    price_str <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    price <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>price_str<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> price <span class=\"token operator\">&lt;=</span> max_price<span class=\"token punctuation\">:</span>\n        flat_list<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> \n            <span class=\"token string\">'link'</span><span class=\"token punctuation\">:</span> link<span class=\"token punctuation\">,</span> \n            <span class=\"token string\">'price'</span><span class=\"token punctuation\">:</span> price<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'image'</span><span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>screenshot_as_png\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Para esto hay muchas formas. Selenium te permite sacar el elemento como imagen, por lo que para después enviarlo de esa manera puede estar muy bien. En mi caso saco el piso como imagen (para enviar después por Telegram así), el precio (para ver que no se pase del tope establecido) y el link, para enviarlo junto a cada imagen para poder meterme en el piso que me interesa. El nombre de la imagen me permite después gestionar las imágenes para enviarlas por Telegram.</p>\n<p>Y esto es todo, así de sencillo. Ya solo hay que enviar esa información por Telegram.</p>\n<h2>Parte 2: crear un bot de Telegram</h2>\n<p>Crear un bot de Telegram es tan sencillo como usar <a href=\"https://t.me/botfather\">BotFather</a>, el bot que te permite crear bots. Tras crear un bot con él, te da un token que es lo que te permite hacer lo que quieras con la API. La creación del bot es trivial, consiste en hablar con el bot.</p>\n<p>Una vez teniendo un token se puede hacer uso del <a href=\"https://github.com/python-telegram-bot/python-telegram-bot\">wrapper para Python</a> que he mencionado. Instalar con <code class=\"language-text\">pip</code> y listo. Del wrapper he utilizado lo siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">import</span> telegram\n<span class=\"token keyword\">from</span> telegram <span class=\"token keyword\">import</span> Bot<span class=\"token punctuation\">,</span> Update\n<span class=\"token keyword\">from</span> telegram<span class=\"token punctuation\">.</span>ext <span class=\"token keyword\">import</span> Updater\n<span class=\"token keyword\">from</span> telegram<span class=\"token punctuation\">.</span>ext <span class=\"token keyword\">import</span> CallbackContext\n<span class=\"token keyword\">from</span> telegram<span class=\"token punctuation\">.</span>ext <span class=\"token keyword\">import</span> CommandHandler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Con ello, se puede instanciar el bot con el token obtenido y crear callbacks que permitan estar a la escucha de comandos de manera sencilla.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token.txt'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        token <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    updater <span class=\"token operator\">=</span> Updater<span class=\"token punctuation\">(</span>token<span class=\"token operator\">=</span>token<span class=\"token punctuation\">,</span> use_context<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    dispatcher <span class=\"token operator\">=</span> updater<span class=\"token punctuation\">.</span>dispatcher\n\n    logging<span class=\"token punctuation\">.</span>basicConfig<span class=\"token punctuation\">(</span><span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class=\"token punctuation\">,</span>\n                        level<span class=\"token operator\">=</span>logging<span class=\"token punctuation\">.</span>INFO<span class=\"token punctuation\">)</span>\n\n    dispatcher<span class=\"token punctuation\">.</span>add_handler<span class=\"token punctuation\">(</span>CommandHandler<span class=\"token punctuation\">(</span><span class=\"token string\">'start'</span><span class=\"token punctuation\">,</span> start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    dispatcher<span class=\"token punctuation\">.</span>add_handler<span class=\"token punctuation\">(</span>CommandHandler<span class=\"token punctuation\">(</span><span class=\"token string\">'bilatu'</span><span class=\"token punctuation\">,</span> bilatu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    dispatcher<span class=\"token punctuation\">.</span>add_handler<span class=\"token punctuation\">(</span>CommandHandler<span class=\"token punctuation\">(</span><span class=\"token string\">'idealista'</span><span class=\"token punctuation\">,</span> idealista<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    dispatcher<span class=\"token punctuation\">.</span>add_handler<span class=\"token punctuation\">(</span>CommandHandler<span class=\"token punctuation\">(</span><span class=\"token string\">'fotocasa'</span><span class=\"token punctuation\">,</span> fotocasa<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    updater<span class=\"token punctuation\">.</span>start_polling<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Esa funcion se ejecuta al arrancar el script. Cojo el token de un archivo separado y creo el bot. En el código se ve que se crean cuatro handlers. Esos son los comandos que después se pueden ejecutar con el bot. en este caso son <code class=\"language-text\">/start</code>,<code class=\"language-text\">/bilatu</code> (“buscar” en euskera),<code class=\"language-text\">/idealista</code> ,<code class=\"language-text\">/fotocasa</code>. Así se puede buscar en todos o solo en uno en específico. Las funciones llamadas con los callbacks son las siguientes:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">bilatu</span><span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">:</span> Update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> CallbackContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    scrap<span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> <span class=\"token string\">'all'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">idealista</span><span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">:</span> Update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> CallbackContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    scrap<span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> <span class=\"token string\">'idealista'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">fotocasa</span><span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">:</span> Update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> CallbackContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    scrap<span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> <span class=\"token string\">'fotocasa'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">scrap</span><span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">:</span> Update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> CallbackContext<span class=\"token punctuation\">,</span> site<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    send_initial_message<span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span>\n    max_price <span class=\"token operator\">=</span> get_max_price<span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span>\n    flat_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> site <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'idealista'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'all'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>\n        flat_list<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>scrap_idealista<span class=\"token punctuation\">(</span>max_price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> site <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'fotocasa'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'all'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>\n        flat_list<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>scrap_fotocasa<span class=\"token punctuation\">(</span>max_price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    send_results<span class=\"token punctuation\">(</span>flat_list<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\n    send_final_message<span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">send_initial_message</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    context<span class=\"token punctuation\">.</span>bot<span class=\"token punctuation\">.</span>send_message<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>update<span class=\"token punctuation\">.</span>effective_chat<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> text<span class=\"token operator\">=</span><span class=\"token string\">'Emaidazu minutu bat!'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">send_final_message</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    context<span class=\"token punctuation\">.</span>bot<span class=\"token punctuation\">.</span>send_message<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>update<span class=\"token punctuation\">.</span>effective_chat<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> text<span class=\"token operator\">=</span><span class=\"token string\">'Hortxe dauzkazu!'</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Baásicamente se llaman a unas u otras funciones de scraping en función de el callback que se ejecuta. Los obtetos <code class=\"language-text\">context</code> y <code class=\"language-text\">update</code> permiten obtener la instancia del bot y toda la información relativa a los comandos que se han ejecutado (qué usuario los ha ejecutado, en que chat, grupo o canal, si ha pasado argumentos, etc.). Ahí también se puede ver los sencillo que es mandar un mensaje con un bot con la funcion <code class=\"language-text\">bot.send_message()</code>.</p>\n<p>Lo interesante de esa parte es la función <code class=\"language-text\">send_results()</code>, que coge lo generado por las funciones de scraping (la lista de pisos, cada uno con toda la información mencionada) y lo envía por Telegram.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">send_results</span><span class=\"token punctuation\">(</span>flat_list<span class=\"token punctuation\">:</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">:</span> Update<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> CallbackContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> flat <span class=\"token keyword\">in</span> flat_list<span class=\"token punctuation\">:</span>\n        context<span class=\"token punctuation\">.</span>bot<span class=\"token punctuation\">.</span>send_photo<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>update<span class=\"token punctuation\">.</span>effective_chat<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> caption<span class=\"token operator\">=</span>flat<span class=\"token punctuation\">[</span><span class=\"token string\">'link'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> photo<span class=\"token operator\">=</span>flat<span class=\"token punctuation\">[</span><span class=\"token string\">'image'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Esto tambien bastante sencillo. Para enviar un mensaje basta con indicar el id del chat (que es algo que se recibe en los callbacks, apra saber desde donde se ha llamdo al comando) y lo que se quiera mandar. Antes se ha visto como se mandaba un mensaje con <code class=\"language-text\">bot.send_message()</code>, pasando el chat y el texto. En este caso se envia la foto de cada piso con <code class=\"language-text\">bot.send_photo()</code>, indicando en <code class=\"language-text\">photo</code> la imagen recogida y en <code class=\"language-text\">caption</code> el link.</p>\n<p>Con todo ello, es tan sencillo como lanzarlo y comenzar a buscar piso.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c7f463628662091337632d0c32a84f79/afd0b/telegram_bot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 108.86075949367088%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAB2HAAAdhwGP5fFlAAAEkUlEQVQ4y32TeUzTZxjHf38JBlgGSG9LOXrRE8oxaDcEa2lLy1VoC0i5xXC4BQNjHHI7dYdLZhQ1HE4YIAphyOFk4MaA6JItWbIlmzqiHNL+etpKT2Av4EayLD755v09efN83/d9Pu/7g8g8cXZ29aOyU0mCRC5fyI6IpjA5VFb4G0QLjWRFxIARIpDpMeyIWqGUExpJpLGDKYygNwoUBFMZpBAWkcqEUCicLxLr7os8hMSCHIU+DIRE4f5fSAwCgUYgsX4IkGCgnWoUDrM77pnRGDwG64/BEbD/EdafRA+jcrhkGovCCAuisiAcPiiYTA8ihgSRaMEkun8AGcyAtb19/Lx9EHvy2Uu8/XABxEAqK5AUAs5PINEgTmRMYrJMLE3jC6V8kTRBkiqRZUfx4sghLDqTA8RgcmiMMCAmO5wQQPTzQ4GlwZkRSAxUX1M13NdZWVp4obXu7JnqO7f6Hy89f7y0vLKuX9ca1zQGjc60DhvX1DqL1VFTU+fh6Q1aQKHxoEGo7sOqof6v2lvre3uudV65ODVxVwNrNLDaoNcZjQaDQa/X63Q62Gazbm9vNzY2e3i+vWve4QqdKiupLlLkvEcpk0QWiaNGB3u3NjctZpPZ8spssTjsNpfLYQcfux2Ym5tbD7h77pulSUlp4mNRFP8EDjmFF9reWH9/dm7i2+8mZ+YnZhYezD+am1+Ynp2bnJ1/sPhzUUk5IZAE7uK1GQBLVqhkqhPJWXnCtCy+JF2iyE+UFwjTc0UZeaL0XIFUJpKkHI2OOsbjMkLoNGY4uMvX5ob3854+vPP01+m+c6WtuUevtZ3+6/nq0rOVdY3hhcag1hrUupcmg+HPW5f+6P+iIjP1oJcv9t+dL9RXPBy9Otnz8dk8QWuecLjrkhrWrK6uaLUanV4Lw7BWp7PabDancwdYU4unl/d+z7Hc8By5+OQRVgr+rRIua/izJlC0w8gJwrW9G1tgxrUJkpbmtgNuHvvmaC4vOj4hlkxOIxMUEYy6fPntb6aGRsYGR+8NjE6PTc2MT94bHpscujs9Nv1jbmFJMIm2D4zH5clkcr5AIk1TCkVJ8QJJkrJAqigUy/MSFQWi9ByBBABLjQulHwll0EgkKiNsH1jH5Q4TvD538+IncZRKP6g7J2FNo19eVRvNVpNlw/hyw2ixW19trIx3r453nVYp3D2894F92tjwy8IPI+cqa7kBIjdopDxdazSu7QCDgWAtrFGvg9CZLaDnM01t/wDDozB4KIf/7u3zH7WI2V9KcKPFxCfXiwEeh90KgDkczj1gm1vbzl3azU0tbuCFHQ5AITEoJBpiE/xVseGySGqlhH659J0rVRkdPf3Xu2929Ax29AzdGBju/Xqg80bf1a7e7r4hZZaKSgtFo7HoYDaaGAZF8eKlyvwMVTE/+Xh8aoEwozC7qEJZUK4oLJfnl2WoTqYpVemZqmSZIiUjMywimkRhIg4hOHx5pPA49EHJiZ7zTX2ftz/5/befFhe/vz+19Gx57QWsV+tMRrPF6tywuRyuLYvZ7NrarK1vcD/oBWjTwH/Ojvgb+hooorqyCAgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Bot de Telegram\"\n        title=\"Bot de Telegram buscando piso\"\n        src=\"/static/c7f463628662091337632d0c32a84f79/f058b/telegram_bot.png\"\n        srcset=\"/static/c7f463628662091337632d0c32a84f79/c26ae/telegram_bot.png 158w,\n/static/c7f463628662091337632d0c32a84f79/6bdcf/telegram_bot.png 315w,\n/static/c7f463628662091337632d0c32a84f79/f058b/telegram_bot.png 630w,\n/static/c7f463628662091337632d0c32a84f79/40601/telegram_bot.png 945w,\n/static/c7f463628662091337632d0c32a84f79/afd0b/telegram_bot.png 1153w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Tal y como queda me parece bastante elegante. Cogiendo el elemento entero como imagen se puede ver toda la información de un vistazo y poniendo el enlace se puede acceder al anuncio para obtener más información o directamente contactar con el anunciante. Otra opción podría haber sido coger el texto y haber creado una lista con los pisos y los enlaces, pero la primera forma me parece de las más elegantes y, sin duda, la más sencilla de todas.</p>\n<h2>Parte 3: crear un canal de Telegram para informar de los pisos</h2>\n<p>Sí, con esto no tengo suficiente. Escribir un comando al bot es demasiado trabajo. Por ello, a parte de tener el bot así, he añadido un metodo para que el bot, cada cierto tiempo, escriba en un canal las ofertas que hay. Esto es basicamente lo msimo que hace por ejemplo el <a href=\"https://t.me/getmanfred\">bot de Manfred</a> con las ofertas de trabajo, pero con mayor frecuencia. Además, me gusta como en ese bot no va dejando los mensajes de días anteriores, sino que solo está el último mensaje. Así evita que se llene el canal de mierda y deja que haya solo lo que tiene que haber. Por ello, yo lo he hecho igual.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">update_channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Get channel and bot info</span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token.txt'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        token <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'channel_id.txt'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        channel_id <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    bot <span class=\"token operator\">=</span> telegram<span class=\"token punctuation\">.</span>Bot<span class=\"token punctuation\">(</span>token<span class=\"token operator\">=</span>token<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Remove previously sended messages</span>\n    stacked_messages <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sent_messages.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">.</span>readlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            stacked_messages<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> stacked_messages<span class=\"token punctuation\">:</span>\n        bot<span class=\"token punctuation\">.</span>delete_message<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>channel_id<span class=\"token punctuation\">,</span> message_id<span class=\"token operator\">=</span>stacked_messages<span class=\"token punctuation\">.</span>pop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Scrap all with the defaul top price</span>\n    flat_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    flat_list<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>scrap_idealista<span class=\"token punctuation\">(</span>top_price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    flat_list<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>scrap_fotocasa<span class=\"token punctuation\">(</span>top_price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># Send the messages with the info</span>\n    <span class=\"token comment\"># Saves the message_id of the messages to be able to delete them on the next one</span>\n    stacked_messages<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>bot<span class=\"token punctuation\">.</span>send_message<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>channel_id<span class=\"token punctuation\">,</span> text<span class=\"token operator\">=</span><span class=\"token string\">'Kaixo! Hamen dauzkazu oraintxe bertan dauden pisuak:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message_id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> flat <span class=\"token keyword\">in</span> flat_list<span class=\"token punctuation\">:</span>\n        stacked_messages<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>bot<span class=\"token punctuation\">.</span>send_photo<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>channel_id<span class=\"token punctuation\">,</span> caption<span class=\"token operator\">=</span>flat<span class=\"token punctuation\">[</span><span class=\"token string\">'link'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> photo<span class=\"token operator\">=</span>flat<span class=\"token punctuation\">[</span><span class=\"token string\">'image'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message_id<span class=\"token punctuation\">)</span>\n        sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    stacked_messages<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>bot<span class=\"token punctuation\">.</span>send_message<span class=\"token punctuation\">(</span>chat_id<span class=\"token operator\">=</span>channel_id<span class=\"token punctuation\">,</span> text<span class=\"token operator\">=</span><span class=\"token string\">'Hortxe dauzkazu!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message_id<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sent_messages.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> message <span class=\"token keyword\">in</span> stacked_messages<span class=\"token punctuation\">:</span>\n            f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Lo sé, esto no es lo más limpio que has visto en tu vida. Es basicamente más de lo mismo pero gestionando los mensajes que se han enviado. Cada mensaje enviado tiene un <code class=\"language-text\">message_id</code>, que es lo que permite despues poder elimiarlos. Esta función basicamente elimina lo que se haya escrito antes en el canal, realiza el scraping, manda la información y guarda los <code class=\"language-text\">message_id</code> para poder borrar los mensajes la próxima vez. Guarda esos id en un fichero para que, si peta el bot, no se pierdan y se puedan borrar al iniciarlo de nuevo, así no queda basura en el canal.</p>\n<p>En este caso, hace falta crear una instancia de <code class=\"language-text\">Bot</code> ya que no se recibe de ningun lado. Ademas de esto, es necesario tener el id del chat o canal en el que se quiera escribir. Hay muchos bots que permiten sacar esos id.</p>\n<p>La idea tener el script en ejecucion 24/7 y con ello el bot siempre listo. Por un lado, con los handlers escuchando, lo que se hace con <code class=\"language-text\">updater.start_polling()</code> visto antes. Por otro lado, hay que tener alguna manera para ejecutar la función <code class=\"language-text\">update_channel()</code> cada cierto tiempo. Para ello se puede usar <code class=\"language-text\">schedule</code>, una librería que permite programar tareas de manera sencilla. Para instalar, usar <code class=\"language-text\">pip</code> y listo.</p>\n<p>Para usarla para ejecutar <code class=\"language-text\">update_channel()</code> cada cierto tiempo, basta con añadir al final de la función <code class=\"language-text\">init()</code> lo siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">schedule<span class=\"token punctuation\">.</span>every<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hour<span class=\"token punctuation\">.</span>at<span class=\"token punctuation\">(</span><span class=\"token string\">\":00\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>do<span class=\"token punctuation\">(</span>update_channel<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    schedule<span class=\"token punctuation\">.</span>run_pending<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Como se ve, es muy sencillo de usar y el código se explica solo. No hay que asustarse por el <code class=\"language-text\">while True</code>. El polling de los callbacks se ejecuta en otros hilos, por lo que esto no interfiere. Esto hace que se quede indefinidamente comprobando si tiene que lanzar alguna tarea.</p>\n<p>Con todo esto, ya solo queda dejarlo en algun lugar ejecutándose. Este tipo de cosas son perfectas para una Raspberry Pi o algo del estilo. También se puede meter en un VPS o en donde sea. Lo único que hay que tener en cuenta es que, o tenga pantalla, o se use alguna libreria como la mencionada para emularla. Además de que tiene que tener el navegador que se vaya a usar instalado.</p>\n<p>También se pueden añádir más sitios a los que hacer scraping, es facilmente escalable. En mi caso uso Idealista y Fotocasa, pero basta con añadir más funciones de scraping. Obviamente, cómo coger la informacion varía de sitio a sitio.</p>\n<h2>Conclusiones</h2>\n<p>Crear un bot de este tipo es una tarea sencilla, como se puede ver. Aquí la dificultad está en encontrar un piso decente que no cueste un ojo de la cara. Eso si que es difícil de verdad.</p>\n<p>Hacer un bot para obtener información actualizada de una puede ser muy util. Usar web scraping en vez de usar APIs tiene sus ventajas. Lo primero es que la mayoria de webs no tienen APIs, por lo que en esos caso no queda otra. En los casos en las que sí tienen, pueden estar limitadas. Lo bueno del web scraping es que te permite coger <strong>lo que tú quieras y como tú quieras</strong>. Y que nadie os engañe; aqui, mientras no tires la web o extraigas datos de manera masiva, no hay delito.</p>\n<p>Espero haberme explicado bien y que si lees esto te pique la curiosidad para trastear con estos temas. Yo, por mi parte no voy a parar :)</p>\n<p>Por último, dejo aquí el <a href=\"https://github.com/ander94lakx/pisu-bot\">repo de GitHub</a> con el código completo. Como siempre, libre para que hagáis lo que queráis.</p>\n<p>Y recordad: <strong><em>Scraping is not a crime!</em></strong></p>","frontmatter":{"title":"Cómo automatizar la búsqueda de piso con un bot de Telegram","date":"February 05, 2022","description":null,"template":"post"}}},"pageContext":{"slug":"/blog/2022-02-05-bot-telegram-buscar-piso/","previous":{"node":{"fields":{"slug":"/blog/2022-01-29-polkit/"},"frontmatter":{"date":"29 January, 2022","title":"Pwnkit: Vulnerabilidad en Polkit (CVE-2021-4034) en 5 minutos","template":"post"}}},"next":{"node":{"fields":{"slug":"/blog/2022-02-13-spotify-data-top-songs/"},"frontmatter":{"date":"13 February, 2022","title":"Cómo sacar tu Top de canciones (o la información que sea) de tu cuenta de Spotify","template":"post"}}}}},"staticQueryHashes":["2841359383","3810545343","916993862"]}