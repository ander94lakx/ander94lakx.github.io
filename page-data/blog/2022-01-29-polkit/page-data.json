{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2022-01-29-polkit/","result":{"data":{"site":{"siteMetadata":{"title":"Walk on the Byte Side","disqusShortname":""}},"markdownRemark":{"id":"c8315277-eea0-5f7f-9677-4ac43e53e196","html":"<p>Otro nuevo CVE de los que han dado que hablar. El <a href=\"https://nvd.nist.gov/vuln/detail/CVE-2021-4034\">CVE-2021-4034</a> salió a la luz hace unos días y se ha esparcido como la pólvora. No es que yo pueda aportar mucho más al tema del que no se haya dicho ya, pero si que puede estar bien hacer un repaso esquemático al CVE y a como explotarlo (que es trivial).</p>\n<h2>¿Qué es polkit?</h2>\n<p><a href=\"https://wiki.archlinux.org/title/Polkit\">Polkit</a> es una herramienta que permite controlar los privilegios en sistemas de tipo Unix. Puede controlar la forma en la que los procesos sin privilegios se comunican con procesos con privilegios.</p>\n<p>Esto es util porque hay muchos casos en los que interesa que un proceso interactúe con procesos privilegiados unicamente para determinadas acciones, pero que no pueda hacer otras. En vez de usar algo como sudo (que sería como “abrir todas las puertas y a ver que pasa”), con Polkit se puede controlar en mayor detalle este tipo de operaciones.</p>\n<h2>¿Cuál es la vulnerabilidad?</h2>\n<p>Polkit tiene una utilidad llamada <a href=\"https://linux.die.net/man/1/pkexec\">pkexec</a>. Esta utilidad permite ejecutar comandos como otro usuario o como root. Esta utilidad tiene una vulnerabilidad, ya que no parsea bien el número de parámetros que recibe y permite ejecutar variables de entorno como comandos (!).</p>\n<p>Entonces, según lo que se le pase como variables de entorno, se puede ejecutar código arbitrario. De ahí, se escala privilegios y se consigue permisos de admin, es decir, root.</p>\n<h2>¿Cómo se puede explotar la vulnerabilidad?</h2>\n<p>Obviamente, ya hay exploits para ello. Para ver lo fácil que es, se puede poner como ejemplo el exploit de <a href=\"https://github.com/berdav/CVE-2021-4034\">Davide Berardi</a>. Ponerlo a prueba es tan sencillo como clonar, compilar, ejecutar y win!</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/berdav/CVE-2021-4034\n<span class=\"token function\">make</span>\n./cve-2021-4034</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Y <em>voilà</em>! ahí tenéis la consola con root.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/90ab5edaeb5e086079e4930dcffecd17/4c5bd/polkit-exploit.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAB2HAAAdhwGP5fFlAAABYUlEQVQoz3WRbW+DIBSF/dRMi1ZxRUVF8a0qCjR1Wf//L9uJzZYmax/IDSE53HMPTkwjxtgZi7EwDA+HwziO9/t927bbE9srnHRmbGCfbZxMiZB1WZZZlgkhiqJArXaklDjXdd00TZqm6BHtONMyjfOoVqW00kajbbcDI5TS4y+e5xFCfN9H/bt01EXNg9qu23W9WmO7tjVGW2vWdRmGAS7wCrolSRIEAQTkCaf+qiorhClzw/GOUmaEGbUaYznn8AwXMIwz+YdTfOf0EhU2z7es7HohdTfd+hlpbRB87Hg7L8TLsDSihXk9aqt1LQrsvm3QbZ5n5IfkHqO+ELdTq6xarJr02LRdUcpa9mXVnM8MeWLO0+lE3uCcdezLYyD904XEvIyz6ZNPqViqqkbPcOetWFoZ8IAkhPCjH9EgyoOIh3ERRRQ5Y2wE/lZMQ0qQBbb7+EGXHD3Ux9+6rvsyqgc/frJAPu1XMGQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Polkit exploit\"\n        title=\"Polkit exploit\"\n        src=\"/static/90ab5edaeb5e086079e4930dcffecd17/f058b/polkit-exploit.png\"\n        srcset=\"/static/90ab5edaeb5e086079e4930dcffecd17/c26ae/polkit-exploit.png 158w,\n/static/90ab5edaeb5e086079e4930dcffecd17/6bdcf/polkit-exploit.png 315w,\n/static/90ab5edaeb5e086079e4930dcffecd17/f058b/polkit-exploit.png 630w,\n/static/90ab5edaeb5e086079e4930dcffecd17/40601/polkit-exploit.png 945w,\n/static/90ab5edaeb5e086079e4930dcffecd17/78612/polkit-exploit.png 1260w,\n/static/90ab5edaeb5e086079e4930dcffecd17/4c5bd/polkit-exploit.png 1435w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>¿Qué sistemas son vulnerables?</h2>\n<p>Pues diría que prácticamente todos. Aquí no se libra ni el apuntador. Se <a href=\"https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034\">ha logrado explotar</a> la vulnerabilidad en instalaciones por defecto de Ubuntu, Debian, Fedora, CentOS y muchas más distribuciones. Al fin y al cabo, teniendo en cuenta que es un componente que se encuentra en prácticamente todas las distribuciones Unix-like.</p>\n<p>Lo peor ya no es eso, sino que la vulnerabilidad lleva <a href=\"https://gitlab.freedesktop.org/polkit/polkit/-/commit/c8c3d835d24fc4ce5a9c596c7d55d85a0311e8d1\">más de 12 años</a> en el código (!). A mi, personalmente, esta es la parte que me asusta de este tipo de vulnerabilidades, las que llevan desde hace mucho pudiendo ser explotadas, por no poder saber hasta que punto se ha podido hacer uso de ella.</p>\n<h2>¿Cómo mitigar la vulnerabilidad?</h2>\n<p>Todo el mundo se ha puesto las pilas y han lanzado parches para ello, por lo que a estas alturas, con actualizar a través del gestor de paquetes debería ser suficiente para mitigarla.</p>\n<p>En el mismo repo del exploit que he mostrado hay una version simplemente para probar si se es vulnerable, que se puede probar de la siguiente manera:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">make</span> dry-run\ndry-run/dry-run-cve-2021-4034</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Otra opción, en caso de que no se pudiera actualizar el sistema, por la razón que fuese (mala idea por cierto, hay que tener siempre actualizados los sistemas), puede ser desactivar el bit SUID de pkexec. Un <code class=\"language-text\">chmod</code> para eliminar el bit para todos:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> ug-s /bin/pkexec</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>De esta manera se impide que el exploit pueda escalar privilegios, aunque puede tener muchas consecuencias imprevistas (como en Half Life :)).</p>\n<h2>Conlusiones</h2>\n<p>A modo de resumen, os dejo unos puntos que me vienen a la cabeza tras ver una vulnerabilidad de este tipo:</p>\n<ul>\n<li>Cuidad vuestras entradas, sobre todo en lenguajes como C y al tratar con elementos a mas bajo nivel.</li>\n<li>Nunca se puede estar completamente seguro. Siempre hay vulnerabilidades que no conocemos pero que pueden ser descubiertas por otros.</li>\n<li>\n<p>Cuanta más gente este del lado de los buenos, más vulnerabilidades de este tipo se podrán descubrir y con mayor rapidez.</p>\n<ul>\n<li>Imaginaos las consecuencias de que esto caiga en malas manos (y no solo hablo de cibercriminales ;)).</li>\n</ul>\n</li>\n</ul>\n<p>Así que ya sabéis, a actualizar vuestros sistemas!</p>\n<p>Happy hacking!</p>\n<h2>¡Exijo más detalles!</h2>\n<p>Pues aquí los tienes:</p>\n<ul>\n<li>El <a href=\"https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt\">reporte original</a>.</li>\n<li>Artículo en <a href=\"https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034\">su blog</a>.</li>\n</ul>\n<p><em>PD</em>: explicaría en detalle la vulnerabilidad, pero creo que ya esta muy bien explicada en cientos de artículos y videos, y no me voy a creer mejor que ellos. Mi objetivo aquí era simplemente hacer un breve resumen de una vulnerabilidad que me ha parecido interesante.</p>","frontmatter":{"title":"Pwnkit: Vulnerabilidad en Polkit (CVE-2021-4034) en 5 minutos","date":"January 29, 2022","description":null,"template":"post"}}},"pageContext":{"slug":"/blog/2022-01-29-polkit/","previous":{"node":{"fields":{"slug":"/blog/2022-01-26-malware-analysis-1/"},"frontmatter":{"date":"26 January, 2022","title":"Análisis de malware (I): cómo empezar a analizar malware","template":"post"}}},"next":{"node":{"fields":{"slug":"/blog/2022-02-05-bot-telegram-buscar-piso/"},"frontmatter":{"date":"05 February, 2022","title":"Cómo automatizar la búsqueda de piso con un bot de Telegram","template":"post"}}}}},"staticQueryHashes":["2841359383","3810545343","916993862"]}