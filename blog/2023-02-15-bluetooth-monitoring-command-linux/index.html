<!doctype html><html lang=en><head><title>How to monitor nearby bluetooth devices with a single command :: Walk on the Byte Side</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Aspaldiko! It&amp;rsquo;s been a long time since I&amp;rsquo;ve been around here, it&amp;rsquo;s been a busy few months (work, moving house, Christmas,&amp;hellip; a thousand things), but it was about time I got back to blogging a bit. Although I still have to continue the series on malware analysis, I&amp;rsquo;ve decided that, in the meantime, I&amp;rsquo;m going to post a few posts about some things I&amp;rsquo;ve been tinkering with lately, like this one, about monitoring bluetooth devices."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ander94lakx.github.io/blog/2023-02-15-bluetooth-monitoring-command-linux/><script async src="https://www.googletagmanager.com/gtag/js?id=G-EPK628CMMZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EPK628CMMZ",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://ander94lakx.github.io/assets/style.css><link rel=stylesheet href=https://ander94lakx.github.io/assets/green.css><link rel=apple-touch-icon href=https://ander94lakx.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://ander94lakx.github.io/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="How to monitor nearby bluetooth devices with a single command"><meta property="og:description" content="Aspaldiko! It&amp;rsquo;s been a long time since I&amp;rsquo;ve been around here, it&amp;rsquo;s been a busy few months (work, moving house, Christmas,&amp;hellip; a thousand things), but it was about time I got back to blogging a bit. Although I still have to continue the series on malware analysis, I&amp;rsquo;ve decided that, in the meantime, I&amp;rsquo;m going to post a few posts about some things I&amp;rsquo;ve been tinkering with lately, like this one, about monitoring bluetooth devices."><meta property="og:url" content="https://ander94lakx.github.io/blog/2023-02-15-bluetooth-monitoring-command-linux/"><meta property="og:site_name" content="Walk on the Byte Side"><meta property="og:image" content="https://ander94lakx.github.io/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-02-16 16:00:00 +0100 +0100"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Walk on the Byte Side</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About me</a></li><li><a href=https://twitter.com/andergrma>Twitter</a></li><li><a href=https://www.instagram.com/andergrma/>Instagram</a></li><li><a href=https://github.com/ander94lakx/>GitHub</a></li><li><a href=/pgp>PGP</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>English ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://ander94lakx.github.io/>English</a></li><li><a href=https://ander94lakx.github.io/es/>Español</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About me</a></li><li><a href=https://twitter.com/andergrma>Twitter</a></li><li><a href=https://www.instagram.com/andergrma/>Instagram</a></li><li><a href=https://github.com/ander94lakx/>GitHub</a></li><li><a href=/pgp>PGP</a></li><hr><li><a href=https://ander94lakx.github.io/>English</a></li><li><a href=https://ander94lakx.github.io/es/>Español</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://ander94lakx.github.io/blog/2023-02-15-bluetooth-monitoring-command-linux/>How to monitor nearby bluetooth devices with a single command</a></h1><div class=post-meta><span class=post-date>2023-02-16</span>
<span class=post-reading-time>:: 8 min read (1529 words)</span></div><span class=post-tags>#<a href=https://ander94lakx.github.io/tags/wireless/>wireless</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/bluetooth/>bluetooth</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/info-gathering/>info-gathering</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/bluetoothctl/>bluetoothctl</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/awk/>awk</a>&nbsp;</span><div class=post-content><div><p>Aspaldiko! It&rsquo;s been a long time since I&rsquo;ve been around here, it&rsquo;s been a busy few months (work, moving house, Christmas,&mldr; a thousand things), but it was about time I got back to blogging a bit. Although I still have to continue the series on malware analysis, I&rsquo;ve decided that, in the meantime, I&rsquo;m going to post a few posts about some things I&rsquo;ve been tinkering with lately, like this one, about monitoring bluetooth devices.</p><p>I love Linux. With linux terminal you feel powerful. It&rsquo;s not that I&rsquo;m an expert using it, but when you know your way around it, you can do a lot of things.</p><p>The other day I wanted to make a small script to monitor the bluetooth devices I have around me. I saw it as an interesting exercise to get data like how many devices I have around, see what kind of devices they are, how many devices are coming and going, and see what can be done with that information.</p><p>My instinct when I wanted to do something like that is to make a script (damn programmers, always <a href=https://www.npmjs.com/package/is-odd>reinventing the wheel</a>). The scripting language I&rsquo;m most comfortable with is Python, so I thought I&rsquo;d use it to do this. Then I figured that what I really wanted to do was just use the output of a command (<code>bluetoothctl</code>), do four things and dump it into a file.</p><p>Then I thought that, for that, what I should do is more like a shell script than using something as <em>overkill</em> as Python. That way, I could use it all the time, less dependencies, etc.</p><p>I wondered if a script was really necessary for this. Maybe between pipes, greps and transformations I could make an <em>oneline</em> that I could put in an alias and that&rsquo;s it. Sometimes, when I look for how to get certain info or how to do certain tasks in Linux, the results of sites like <em>Super User</em> show people putting crazy commands to do all kinds of things, so I thought I could do the same, or at least try to do it. So today I&rsquo;m going to explain how to set up a command to monitor the bluetooth devices around me.</p><p>First things first. The bluetooth tool I used is <code>bluetoothctl</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bluetoothctl
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-1.png alt="Bluetooth oneliner"></p><p>If run, it can be seen that it works in interactive mode. To scan for devices, you simply use the <code>scan on</code> subcommand, and it starts detecting devices that appear, disappear or change properties.</p><p><img src=/static/images/bt-oneline/bt-oneline-2.png alt="Bluetooth oneliner"></p><p>Here comes the first problem. Since I want to redirect the output of this, interactive mode doesn&rsquo;t work for me. In Bash (and other shells like Zsh, which I use), a <code>--</code> indicates the end of commands, after which you can pass parameters. So, if you put the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bluetoothctl -- scan on
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-3.png alt="Bluetooth oneliner"></p><p>It already returns everything via standard output and without interactive mode.</p><p>The next step is to start doing some transformations. First of all, I want to cut some parameters, dump this and filter some lines according to their content. For this I know that the best way is to use the advanced but intimidating <code>awk</code>. I have seen some <a href="https://www.youtube.com/watch?v=W5kr7X7EG4o">videos</a> about it but I have never used it beyond copy-pasting. Just to test it, I&rsquo;ve tried using the option to print what it returns, as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bluetoothctl -- scan on | awk <span style=color:#e6db74>&#39;{print}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-4.png alt="Bluetooth oneliner"></p><p>Shit. Another problem. Nothing comes out. Looking on the internet, I see that the reason is a buffering issue. As the output is continuous, until the <code>bluetoothctl</code> buffer is freed, the output is not redirected to <code>awk</code>, so it is useless. Also looking on the internet, I see that I can solve this with <code>stdbuf</code> and some specific arguments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on | awk <span style=color:#e6db74>&#39;{print}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-5.png alt="Bluetooth oneliner"></p><p>(I will not go into the detailed explanation of all the commands and arguments, as I will never be able to do it as well as <code>man</code> or other anonymous internet users).</p><p>OK, now it works, so we can get serious. To show only certain parts, you can use the dollar syntax, which allows you to select certain parameters on each input line.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\ </span>
</span></span><span style=display:flex><span>	| awk <span style=color:#e6db74>&#39;{print $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-6.png alt="Bluetooth oneliner"></p><p>By selecting the first, third and fourth, only those fields are displayed. By default, the separator is the space, but if you want to specify or use any other separator, you can indicate it with <code>-F</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| awk -F<span style=color:#e6db74>&#39;[ ]&#39;</span> <span style=color:#e6db74>&#39;{print $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-7.png alt="Bluetooth oneliner"></p><p>Knowing how to grab fields, I am now interested in grabbing only certain lines. You can set conditions for certain lines. I know that the lines I am interested in are the ones with &ldquo;Device&rdquo; in the second parameter. To put this in <code>awk</code>, it is expressed before the <code>print</code> command as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| awk -F<span style=color:#e6db74>&#39;[ ]&#39;</span> <span style=color:#e6db74>&#39;$2 ~ /Device/  {print $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-8.png alt="Bluetooth oneliner"></p><p>You can even set several conditions, each with its own regex. In my case, the lines I&rsquo;m interested in are the ones with a <code>[NEW]</code> or a <code>[DEL]</code>, which is what determines when a device is found and when it is not detected. This, together with the &ldquo;Device&rdquo;, limits perfectly what I am trying to monitor. To set this, you put it with <code>&&</code> and limiting conditions in brackets. As regexes are used, the single pipe (<code>|</code>) is used to say that any of these two values are valid, so it looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| awk -F<span style=color:#e6db74>&#39;[ ]&#39;</span> <span style=color:#e6db74>&#39;($2 ~ /Device/ &amp;&amp; $1 ~ /[NEW]|[DEL]/) {print $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-11.png alt="Bluetooth oneliner"></p><p>So far so good, but a log is useless if it doesn&rsquo;t have timestamps. <code>awk</code> is so powerful that you can use some functions inside it (I don&rsquo;t know if this is built-in of <code>awk</code> or not, but it is amazing). In this case, I add to my <code>print</code> a call to <code>strftime()</code> with the format I like, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| awk -F<span style=color:#e6db74>&#39;[ ]&#39;</span> <span style=color:#e6db74>&#39;($2 ~ /Device/ &amp;&amp; $1 ~ /[NEW]|[DEL]/)  {print strftime(&#34;%Y/%m/%d-%H:%M:%S-%Z&#34;, systime()) &#34;,&#34; $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span>
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-10.png alt="Bluetooth oneliner"></p><p>At this point I&rsquo;m already amazed at what can be done with a single line and by putting commands together (I&rsquo;ve saved so many lines of Python with this). Now, the last thing I need to do is to dump it to a file.</p><p>Something I was interested in was to dump it to a file but to see the output at the same time. For this <code>tee</code> is perfect. We pass the output from <code>awk</code> to <code>tee</code> with a pipe and we&rsquo;re done:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| awk -F<span style=color:#e6db74>&#39;[ ]&#39;</span> <span style=color:#e6db74>&#39;($2 ~ /Device/ &amp;&amp; $1 ~ /[NEW]|[DEL]/)  {print strftime(&#34;%Y/%m/%d-%H:%M:%S-%Z&#34;, systime()) &#34;,&#34; $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span> | tee -a bluetooth_scan_log.txt
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-12.png alt="Bluetooth oneliner"></p><p>Shit. It doesn&rsquo;t work. But wait, this sounds familiar. We have between <code>awk</code> and <code>tee</code> the same problem we had with <code>bluetoothctl</code> and <code>awk</code>, so we tried to solve it the same way and that&rsquo;s it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>stdbuf -oL bluetoothctl -- scan on <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| stdbuf -oL awk -F<span style=color:#e6db74>&#39;[ ]&#39;</span> <span style=color:#e6db74>&#39;($2 ~ /Device/ &amp;&amp; $1 ~ /[NEW]|[DEL]/)  {print strftime(&#34;%Y/%m/%d-%H:%M:%S-%Z&#34;, systime()) &#34;,&#34; $1 &#34;,&#34; $3 &#34;,&#34; $4}&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	| tee -a bluetooth_scan_log.txt
</span></span></code></pre></div><p><img src=/static/images/bt-oneline/bt-oneline-13.png alt="Bluetooth oneliner"></p><p>And that&rsquo;s it. Now we have the whole &ldquo;system&rdquo; set up. Once done, I have seen that there are several details to correct, like maybe taking just those parameters is not a good idea because the fourth parameter can be cut with spaces, or maybe I am not interested in filtering so much information.</p><p>Anyway, that&rsquo;s not the important thing. The essential thing is that, with a few commands, a bit of trial and error and our friends Google and <code>man</code>, you can set up a lot of things, without having to do scripts or anything. This has several advantages:</p><ul><li><p>Use standard tools, which are available in most Linux distributions, which ensures that you can use it everywhere.</p></li><li><p>Less scripting. Don&rsquo;t get me wrong, I love programming, but why do it if there are already solid and proven commands that allow you to do it. No need to reinvent the wheel, <em>Keep It Simple, Stupid!</em></p></li><li><p>Be able to put it as an alias (or <em>oneline</em> function if quotes are too much trouble) in a <code>.bashrc</code> (or <code>.zshrc</code> in my case). Running this by typing a single word makes you feel very powerful.</p></li></ul><p>And that is all. I know, and I realised as I was doing it, that there are many ways to improve this. Some I&rsquo;ve seen, some I haven&rsquo;t even realised. My intention with this is just to show the beauty and the magic of using standard tools and the terminal, and how powerful these tools are to do a lot of things that, in the end, don&rsquo;t need to be programmed.</p><p>Whenever you are going to do something like this, ask yourself if someone would be able to do this with a command. If the answer to that question is yes, look for it, and if you can&rsquo;t find it, open the terminal.</p><p><em>Happy Hacking!</em></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://ander94lakx.github.io/blog/2023-08-19-blog-multilingual/><span class=button__icon>←</span>
<span class=button__text>The blog is now multilingual</span></a></span>
<span class="button next"><a href=https://ander94lakx.github.io/blog/2022-09-11-malware-analysis-2/><span class=button__text>Malware analysis (II) - Basic static analysis: strings and metadata</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://ander94lakx.github.io/assets/main.js></script>
<script src=https://ander94lakx.github.io/assets/prism.js></script>
<script src=https://ander94lakx.github.io/assets/languageSelector.js></script></div></body></html>