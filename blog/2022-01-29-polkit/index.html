<!doctype html><html lang=en><head><title>Pwnkit: Vulnerability in Polkit (CVE-2021-4034) in 5 minutes :: Walk on the Byte Side</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Another new CVE that has been making headlines. The CVE-2021-4034 was released a few days ago and has spread like wildfire. I can&rsquo;t really contribute much more to the topic that hasn&rsquo;t already been said, but it might be good to give a brief overview of the CVE and how to exploit it (which is trivial).
What is polkit? Polkit is a tool for controlling privileges on Unix-like systems. It can control how unprivileged processes communicate with privileged processes.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ander94lakx.github.io/blog/2022-01-29-polkit/><script async src="https://www.googletagmanager.com/gtag/js?id=G-EPK628CMMZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EPK628CMMZ")}</script><link rel=stylesheet href=https://ander94lakx.github.io/assets/style.css><link rel=stylesheet href=https://ander94lakx.github.io/assets/green.css><link rel=apple-touch-icon href=https://ander94lakx.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://ander94lakx.github.io/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Ander Granado"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Pwnkit: Vulnerability in Polkit (CVE-2021-4034) in 5 minutes"><meta property="og:description" content="Another new CVE that has been making headlines. The CVE-2021-4034 was released a few days ago and has spread like wildfire. I can&rsquo;t really contribute much more to the topic that hasn&rsquo;t already been said, but it might be good to give a brief overview of the CVE and how to exploit it (which is trivial).
What is polkit? Polkit is a tool for controlling privileges on Unix-like systems. It can control how unprivileged processes communicate with privileged processes.
"><meta property="og:url" content="https://ander94lakx.github.io/blog/2022-01-29-polkit/"><meta property="og:site_name" content="Walk on the Byte Side"><meta property="og:image" content="https://ander94lakx.github.io/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-01-29 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Walk on the Byte Side</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About me</a></li><li><a href=https://twitter.com/andergrma>Twitter</a></li><li><a href=https://www.instagram.com/andergrma/>Instagram</a></li><li><a href=https://github.com/ander94lakx/>GitHub</a></li><li><a href=/pgp>PGP</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>English ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://ander94lakx.github.io/>English</a></li><li><a href=https://ander94lakx.github.io/es/>Español</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About me</a></li><li><a href=https://twitter.com/andergrma>Twitter</a></li><li><a href=https://www.instagram.com/andergrma/>Instagram</a></li><li><a href=https://github.com/ander94lakx/>GitHub</a></li><li><a href=/pgp>PGP</a></li><hr><li><a href=https://ander94lakx.github.io/>English</a></li><li><a href=https://ander94lakx.github.io/es/>Español</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://ander94lakx.github.io/blog/2022-01-29-polkit/>Pwnkit: Vulnerability in Polkit (CVE-2021-4034) in 5 minutes</a></h1><div class=post-meta><span class=post-date>2022-01-29
</span><span class=post-author>:: Ander Granado</span>
<span class=post-reading-time>:: 4 min read (654 words)</span></div><span class=post-tags>#<a href=https://ander94lakx.github.io/tags/polkit/>polkit</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/exploit/>exploit</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/cve/>cve</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/vulnerability/>vulnerability</a>&nbsp;</span><div class=post-content><div><p>Another new CVE that has been making headlines. The <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-4034>CVE-2021-4034</a> was released a few days ago and has spread like wildfire. I can&rsquo;t really contribute much more to the topic that hasn&rsquo;t already been said, but it might be good to give a brief overview of the CVE and how to exploit it (which is trivial).</p><h2 id=what-is-polkit>What is polkit?<a href=#what-is-polkit class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://wiki.archlinux.org/title/Polkit>Polkit</a> is a tool for controlling privileges on Unix-like systems. It can control how unprivileged processes communicate with privileged processes.</p><p>This is useful because there are many cases where a process needs to interact with privileged processes only for certain actions, but not for other ones. Instead of using something like sudo (which would be like &ldquo;open all the doors and see what happens&rdquo;), with Polkit you can control this kind of operations in more detail.</p><h2 id=what-is-the-vulnerability>What is the vulnerability?<a href=#what-is-the-vulnerability class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Polkit has a utility called <a href=https://linux.die.net/man/1/pkexec>pkexec</a>. This utility allows to execute commands as another user or as root. This utility has a vulnerability, as it does not properly parse the number of parameters it receives and allows environment variables to be executed as commands (!).</p><p>Then, depending on what is passed as environment variables, arbitrary code can be executed. From there, you can escalate privileges and get admin permissions, i.e. root.</p><h2 id=how-can-the-vulnerability-be-exploited>How can the vulnerability be exploited?<a href=#how-can-the-vulnerability-be-exploited class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Obviously, there are already exploits for this. To see how easy it is, you can use [Davide Berardi]&rsquo;s exploit (<a href=https://github.com/berdav/CVE-2021-4034>https://github.com/berdav/CVE-2021-4034</a>) as an example. Testing it is as easy as clone, compile, run and win!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/berdav/CVE-2021-4034
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>./cve-2021-4034
</span></span></code></pre></div><p>And <em>voilà</em>! there you have the root shell.</p><p><img alt="Polkit exploit" src=/static/images/polkit-exploit.png title="Polkit exploit"></p><h2 id=which-systems-are-vulnerable>Which systems are vulnerable?<a href=#which-systems-are-vulnerable class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Well, I would say practically all of them. The vulnerability has been <a href=https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034>successfully exploited</a> in default installations of Ubuntu, Debian, Fedora, CentOS and many more distributions. After all, it is a component found in practically all Unix-like distributions.</p><p>The worst thing is not only that, but that the vulnerability has been in the code for <a href=https://gitlab.freedesktop.org/polkit/polkit/-/commit/c8c3d835d24fc4ce5a9c596c7d55d85a0311e8d1>more than 12 years</a> (!). For me, personally, this is the part that scares me about this kind of vulnerability, the ones that have been open to exploitation for a long time, because I don&rsquo;t know to what extent they have been exploited previously.</p><h2 id=how-to-mitigate-the-vulnerability>How to mitigate the vulnerability?<a href=#how-to-mitigate-the-vulnerability class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Everyone&rsquo;s been doing their best to patch it, so at this point, updating via the package manager should be enough to mitigate it.</p><p>In the same exploit repo that I have shown there is a version just to test if you are vulnerable, which can be tested as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make dry-run
</span></span><span style=display:flex><span>dry-run/dry-run-cve-2021-4034
</span></span></code></pre></div><p>Another option, in case of the system could not be updated (bad idea by the way, you should always keep your systems up to date), could be to disable the SUID bit of pkexec. A <code>chmod</code> to remove the bit for everyone:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod ug-s /bin/pkexec
</span></span></code></pre></div><p>This prevents the exploit from escalating privileges, although it can have many unforeseen consequences (as in Half Life :)).</p><h2 id=conlusions>Conlusions<a href=#conlusions class=hanchor arialabel=Anchor>&#8983;</a></h2><p>To summarise, here are a few points that come to mind after seeing a vulnerability of this type:</p><ul><li>Be careful with your inputs, especially in languages like C and when dealing with lower level elements.</li><li>You can never be completely sure. There are always vulnerabilities that we don&rsquo;t know about but can be discovered by others.</li><li>The more people are on the side of the good guys, the more such vulnerabilities can be discovered, and faster.<ul><li>Imagine the consequences of this falling into the wrong hands (and I&rsquo;m not just talking about cybercriminals ;)).</li></ul></li></ul><p>So you know, update your systems!</p><p>Happy hacking!</p><h2 id=i-want-more-details>I want more details!<a href=#i-want-more-details class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Well, here they are:</p><ul><li>The <a href=https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt>original report</a>.</li><li>Article in <a href=https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034>his blog</a>.</li></ul><p><em>PS</em>: I would explain the vulnerability in detail, but I think it&rsquo;s already very well explained in hundreds of articles and videos, and I&rsquo;m not going to think I&rsquo;m better than them. My goal here was simply to make a brief summary of a vulnerability that I found interesting.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://ander94lakx.github.io/blog/2022-02-05-bot-telegram-find-flat/><span class=button__icon>←</span>
<span class=button__text>How to automate flat-hunting with a Telegram bot</span>
</a></span><span class="button next"><a href=https://ander94lakx.github.io/blog/2020-04-25-instagram-bot-python/><span class=button__text>How to download images from an Instagram profile with Python and web scrapping</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://ander94lakx.github.io/assets/main.js></script><script src=https://ander94lakx.github.io/assets/prism.js></script><script src=https://ander94lakx.github.io/assets/languageSelector.js></script></div></body></html>