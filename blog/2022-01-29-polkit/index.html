<!doctype html><html lang=es><head><title>Pwnkit: Vulnerabilidad en Polkit (CVE-2021-4034) en 5 minutos :: Walk on the Byte Side</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Otro nuevo CVE de los que han dado que hablar. El CVE-2021-4034 salió a la luz hace unos días y se ha esparcido como la pólvora. No es que yo pueda aportar mucho más al tema del que no se haya dicho ya, pero si que puede estar bien hacer un repaso esquemático al CVE y a como explotarlo (que es trivial).
¿Qué es polkit? Polkit es una herramienta que permite controlar los privilegios en sistemas de tipo Unix."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ander94lakx.github.io/blog/2022-01-29-polkit/><script async src="https://www.googletagmanager.com/gtag/js?id=G-EPK628CMMZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EPK628CMMZ",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://ander94lakx.github.io/assets/style.css><link rel=stylesheet href=https://ander94lakx.github.io/assets/green.css><link rel=apple-touch-icon href=https://ander94lakx.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://ander94lakx.github.io/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Ander Granado"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="og:title" content="Pwnkit: Vulnerabilidad en Polkit (CVE-2021-4034) en 5 minutos"><meta property="og:description" content="Otro nuevo CVE de los que han dado que hablar. El CVE-2021-4034 salió a la luz hace unos días y se ha esparcido como la pólvora. No es que yo pueda aportar mucho más al tema del que no se haya dicho ya, pero si que puede estar bien hacer un repaso esquemático al CVE y a como explotarlo (que es trivial).
¿Qué es polkit? Polkit es una herramienta que permite controlar los privilegios en sistemas de tipo Unix."><meta property="og:url" content="https://ander94lakx.github.io/blog/2022-01-29-polkit/"><meta property="og:site_name" content="Walk on the Byte Side"><meta property="og:image" content="https://ander94lakx.github.io/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-01-29 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Walk on the Byte side</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>Sobre mí</a></li><li><a href=https://twitter.com/andergrma>Twitter</a></li><li><a href=https://www.instagram.com/andergrma/>Instagram</a></li><li><a href=https://github.com/ander94lakx/>GitHub</a></li><li><a href=/pgp>PGP</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>Sobre mí</a></li><li><a href=https://twitter.com/andergrma>Twitter</a></li><li><a href=https://www.instagram.com/andergrma/>Instagram</a></li><li><a href=https://github.com/ander94lakx/>GitHub</a></li><li><a href=/pgp>PGP</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://ander94lakx.github.io/blog/2022-01-29-polkit/>Pwnkit: Vulnerabilidad en Polkit (CVE-2021-4034) en 5 minutos</a></h1><div class=post-meta><span class=post-date>2022-01-29</span>
<span class=post-author>:: Ander Granado</span>
<span class=post-reading-time>:: 4 min read (700 words)</span></div><span class=post-tags>#<a href=https://ander94lakx.github.io/tags/polkit/>polkit</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/exploit/>exploit</a>&nbsp;
#<a href=https://ander94lakx.github.io/tags/linux/>linux</a>&nbsp;</span><div class=post-content><div><p>Otro nuevo CVE de los que han dado que hablar. El <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-4034>CVE-2021-4034</a> salió a la luz hace unos días y se ha esparcido como la pólvora. No es que yo pueda aportar mucho más al tema del que no se haya dicho ya, pero si que puede estar bien hacer un repaso esquemático al CVE y a como explotarlo (que es trivial).</p><h2 id=qué-es-polkit>¿Qué es polkit?<a href=#qué-es-polkit class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://wiki.archlinux.org/title/Polkit>Polkit</a> es una herramienta que permite controlar los privilegios en sistemas de tipo Unix. Puede controlar la forma en la que los procesos sin privilegios se comunican con procesos con privilegios.</p><p>Esto es util porque hay muchos casos en los que interesa que un proceso interactúe con procesos privilegiados unicamente para determinadas acciones, pero que no pueda hacer otras. En vez de usar algo como sudo (que sería como &ldquo;abrir todas las puertas y a ver que pasa&rdquo;), con Polkit se puede controlar en mayor detalle este tipo de operaciones.</p><h2 id=cuál-es-la-vulnerabilidad>¿Cuál es la vulnerabilidad?<a href=#cuál-es-la-vulnerabilidad class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Polkit tiene una utilidad llamada <a href=https://linux.die.net/man/1/pkexec>pkexec</a>. Esta utilidad permite ejecutar comandos como otro usuario o como root. Esta utilidad tiene una vulnerabilidad, ya que no parsea bien el número de parámetros que recibe y permite ejecutar variables de entorno como comandos (!).</p><p>Entonces, según lo que se le pase como variables de entorno, se puede ejecutar código arbitrario. De ahí, se escala privilegios y se consigue permisos de admin, es decir, root.</p><h2 id=cómo-se-puede-explotar-la-vulnerabilidad>¿Cómo se puede explotar la vulnerabilidad?<a href=#cómo-se-puede-explotar-la-vulnerabilidad class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Obviamente, ya hay exploits para ello. Para ver lo fácil que es, se puede poner como ejemplo el exploit de <a href=https://github.com/berdav/CVE-2021-4034>Davide Berardi</a>. Ponerlo a prueba es tan sencillo como clonar, compilar, ejecutar y win!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/berdav/CVE-2021-4034
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>./cve-2021-4034
</span></span></code></pre></div><p>Y <em>voilà</em>! ahí tenéis la consola con root.</p><p><img src=/static/images/polkit-exploit.png alt="Polkit exploit" title="Polkit exploit"></p><h2 id=qué-sistemas-son-vulnerables>¿Qué sistemas son vulnerables?<a href=#qué-sistemas-son-vulnerables class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Pues diría que prácticamente todos. Aquí no se libra ni el apuntador. Se <a href=https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034>ha logrado explotar</a> la vulnerabilidad en instalaciones por defecto de Ubuntu, Debian, Fedora, CentOS y muchas más distribuciones. Al fin y al cabo, teniendo en cuenta que es un componente que se encuentra en prácticamente todas las distribuciones Unix-like.</p><p>Lo peor ya no es eso, sino que la vulnerabilidad lleva <a href=https://gitlab.freedesktop.org/polkit/polkit/-/commit/c8c3d835d24fc4ce5a9c596c7d55d85a0311e8d1>más de 12 años</a> en el código (!). A mi, personalmente, esta es la parte que me asusta de este tipo de vulnerabilidades, las que llevan desde hace mucho pudiendo ser explotadas, por no poder saber hasta que punto se ha podido hacer uso de ella.</p><h2 id=cómo-mitigar-la-vulnerabilidad>¿Cómo mitigar la vulnerabilidad?<a href=#cómo-mitigar-la-vulnerabilidad class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Todo el mundo se ha puesto las pilas y han lanzado parches para ello, por lo que a estas alturas, con actualizar a través del gestor de paquetes debería ser suficiente para mitigarla.</p><p>En el mismo repo del exploit que he mostrado hay una version simplemente para probar si se es vulnerable, que se puede probar de la siguiente manera:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make dry-run
</span></span><span style=display:flex><span>dry-run/dry-run-cve-2021-4034
</span></span></code></pre></div><p>Otra opción, en caso de que no se pudiera actualizar el sistema, por la razón que fuese (mala idea por cierto, hay que tener siempre actualizados los sistemas), puede ser desactivar el bit SUID de pkexec. Un <code>chmod</code> para eliminar el bit para todos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod ug-s /bin/pkexec
</span></span></code></pre></div><p>De esta manera se impide que el exploit pueda escalar privilegios, aunque puede tener muchas consecuencias imprevistas (como en Half Life :)).</p><h2 id=conlusiones>Conlusiones<a href=#conlusiones class=hanchor arialabel=Anchor>&#8983;</a></h2><p>A modo de resumen, os dejo unos puntos que me vienen a la cabeza tras ver una vulnerabilidad de este tipo:</p><ul><li>Cuidad vuestras entradas, sobre todo en lenguajes como C y al tratar con elementos a mas bajo nivel.</li><li>Nunca se puede estar completamente seguro. Siempre hay vulnerabilidades que no conocemos pero que pueden ser descubiertas por otros.</li><li>Cuanta más gente este del lado de los buenos, más vulnerabilidades de este tipo se podrán descubrir y con mayor rapidez.<ul><li>Imaginaos las consecuencias de que esto caiga en malas manos (y no solo hablo de cibercriminales ;)).</li></ul></li></ul><p>Así que ya sabéis, a actualizar vuestros sistemas!</p><p>Happy hacking!</p><h2 id=exijo-más-detalles>¡Exijo más detalles!<a href=#exijo-más-detalles class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Pues aquí los tienes:</p><ul><li>El <a href=https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt>reporte original</a>.</li><li>Artículo en <a href=https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034>su blog</a>.</li></ul><p><em>PD</em>: explicaría en detalle la vulnerabilidad, pero creo que ya esta muy bien explicada en cientos de artículos y videos, y no me voy a creer mejor que ellos. Mi objetivo aquí era simplemente hacer un breve resumen de una vulnerabilidad que me ha parecido interesante.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Leer otros posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://ander94lakx.github.io/blog/2022-02-05-bot-telegram-buscar-piso/><span class=button__icon>←</span>
<span class=button__text>Cómo automatizar la búsqueda de piso con un bot de Telegram</span></a></span>
<span class="button next"><a href=https://ander94lakx.github.io/blog/2022-01-26-malware-analysis-1/><span class=button__text>Análisis de malware (I) - Cómo empezar a analizar malware</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://ander94lakx.github.io/assets/main.js></script>
<script src=https://ander94lakx.github.io/assets/prism.js></script></div></body></html>